<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>ページ詳細</title>
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <a href="index.html" onclick="event.preventDefault(); goBack();" class="child-page-btn" style="margin:20px; display:inline-block;">戻る</a>
  <div id="pageDetails" class="files-section"></div>
<script>
function goBack() {
  window.location.href = 'index.html';
}
document.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(window.location.search);
  const pageId = params.get('pageId');
  if (!pageId) return;
  loadPageDetails(pageId);
});

async function loadPageDetails(pageId) {
  try {
    const response = await fetch('/page/' + pageId);
    if (!response.ok) throw new Error('HTTP ' + response.status);
    const data = await response.json();
    const container = document.getElementById('pageDetails');
    container.innerHTML = '';

    const title = data.page?.properties?.Name?.title?.[0]?.plain_text || data.page?.properties?.Name?.title?.[0]?.text?.content || 'ページ';
    const titleEl = document.createElement('h2');
    titleEl.textContent = title;
    container.appendChild(titleEl);

    if (data.files && data.files.length > 0) {
      const filesTitle = document.createElement('h4');
      filesTitle.textContent = 'ファイル:';
      container.appendChild(filesTitle);

      data.files.forEach(file => {
        const fileDiv = document.createElement('div');
        fileDiv.className = 'file-item';

        const icon = document.createElement('span');
        icon.className = 'pdf-icon';
        icon.textContent = '📄';

        const link = document.createElement('a');
        link.className = 'file-link';
        link.href = file.url;
        link.textContent = file.name;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';

        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'file-actions';

        const viewBtn = document.createElement('button');
        viewBtn.className = 'file-btn';
        viewBtn.textContent = '表示';
        viewBtn.onclick = () => {
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          if (isIOS) {
            window.open(file.url, '_blank', 'noopener,noreferrer');
          } else {
            showPDF(file.url, file.name, container);
          }
        };

        const openTabBtn = document.createElement('button');
        openTabBtn.className = 'file-btn open-tab';
        openTabBtn.textContent = '新しいタブで開く';
        openTabBtn.onclick = () => window.open(file.url, '_blank', 'noopener,noreferrer');

        actionsDiv.appendChild(viewBtn);
        if (!/iPad|iPhone|iPod/.test(navigator.userAgent)) {
          actionsDiv.appendChild(openTabBtn);
        }
        fileDiv.appendChild(icon);
        fileDiv.appendChild(link);
        fileDiv.appendChild(actionsDiv);
        container.appendChild(fileDiv);
      });
    }

    if (data.childPages && data.childPages.length > 0) {
      const childTitle = document.createElement('h4');
      childTitle.textContent = '子ページ:';
      childTitle.style.marginTop = '20px';
      container.appendChild(childTitle);

      data.childPages.forEach(child => {
        const childDiv = document.createElement('div');
        childDiv.className = 'child-page-item';

        const h5 = document.createElement('h5');
        h5.textContent = child.title;
        childDiv.appendChild(h5);

        if (child.error) {
          const errorMsg = document.createElement('div');
          errorMsg.textContent = child.error;
          errorMsg.style.cssText = 'color: #e74c3c; font-style: italic; font-size: 14px;';
          childDiv.appendChild(errorMsg);
        } else {
          const btn = document.createElement('button');
          btn.textContent = '子ページを表示';
          btn.classList.add('child-page-btn');
          btn.onclick = () => showChildPageDetails(child.id, childDiv, btn);
          childDiv.appendChild(btn);
        }
        container.appendChild(childDiv);
      });
    }

    if (data.content && data.content.length > 0) {
      const parentContentBlocks = data.content.filter(b => b.type !== 'child_page');
      let markdown = '';
      parentContentBlocks.forEach(block => {
        if (block.type === 'paragraph' && block.paragraph.rich_text) {
          const text = block.paragraph.rich_text.map(t => t.plain_text).join('');
          if (text.trim()) markdown += text + '\n\n';
        } else if (block.type === 'heading_1' && block.heading_1.rich_text) {
          const text = block.heading_1.rich_text.map(t => t.plain_text).join('');
          if (text.trim()) markdown += '# ' + text + '\n\n';
        } else if (block.type === 'heading_2' && block.heading_2.rich_text) {
          const text = block.heading_2.rich_text.map(t => t.plain_text).join('');
          if (text.trim()) markdown += '## ' + text + '\n\n';
        } else if (block.type === 'heading_3' && block.heading_3.rich_text) {
          const text = block.heading_3.rich_text.map(t => t.plain_text).join('');
          if (text.trim()) markdown += '### ' + text + '\n\n';
        } else if (block.type === 'bulleted_list_item' && block.bulleted_list_item.rich_text) {
          const text = block.bulleted_list_item.rich_text.map(t => t.plain_text).join('');
          if (text.trim()) markdown += '• ' + text + '\n';
        } else if (block.type === 'numbered_list_item' && block.numbered_list_item.rich_text) {
          const text = block.numbered_list_item.rich_text.map(t => t.plain_text).join('');
          if (text.trim()) markdown += '1. ' + text + '\n';
        } else if (block.type === 'table') {
          markdown += '\n[TABLE_START]\n';
        } else if (block.type === 'table_row' && block.table_row && block.table_row.cells) {
          const cells = block.table_row.cells.map(cell => cell.map(t => t.plain_text).join('').trim());
          markdown += '| ' + cells.join(' | ') + ' |\n';
        }
      });
      if (markdown.trim()) {
        const contentDiv = document.createElement('div');
        contentDiv.className = 'page-content';
        contentDiv.style.marginTop = '20px';

        const contentTitle = document.createElement('h4');
        contentTitle.textContent = 'メインページ内容:';
        contentTitle.style.cssText = 'color: var(--text-color); margin-bottom: 10px; font-size: 16px; border-bottom: 2px solid rgba(44,62,80,0.1); padding-bottom:5px;';
        contentDiv.appendChild(contentTitle);

        const contentText = document.createElement('div');
        contentText.className = 'page-text';
        contentText.innerHTML = parseMarkdownToHTML(markdown);
        contentDiv.appendChild(contentText);

        container.appendChild(contentDiv);
      }
    }

    if ((!data.files || data.files.length === 0) && (!data.content || data.content.length === 0)) {
      container.innerHTML += '<div style="color: var(--text-color); font-style: italic; text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; border: 1px dashed rgba(44, 62, 80, 0.3);">ファイルとページ内容はありません</div>';
    }

  } catch(err) {
    const container = document.getElementById('pageDetails');
    container.innerHTML = '<div style="color:#e74c3c;">エラー: 詳細を取得できませんでした</div>';
  }
}

async function showChildPageDetails(childPageId, container, button) {
  const existing = container.querySelector('.child-page-details');
  if (existing) return;

  const originalText = button.textContent;
  button.textContent = '読み込み中...';
  button.style.pointerEvents = 'none';
  button.style.opacity = '0.6';

  try {
    const response = await fetch('/child-page/' + childPageId);
    if (!response.ok) throw new Error('HTTP ' + response.status);
    const data = await response.json();

    const detail = document.createElement('div');
    detail.className = 'child-page-details';
    container.appendChild(detail);

    if (data.files && data.files.length > 0) {
      const ft = document.createElement('h6');
      ft.textContent = 'ファイル:';
      ft.style.cssText = 'margin:0 0 10px 0;color:var(--text-color);font-size:14px;';
      detail.appendChild(ft);

      data.files.forEach(f => {
        const fileDiv = document.createElement('div');
        fileDiv.className = 'child-file-item';

        const icon = document.createElement('span');
        icon.textContent = '📄';
        icon.style.marginRight = '8px';

        const link = document.createElement('a');
        link.href = f.url;
        link.textContent = f.name;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.style.cssText = 'color: var(--accent-color); text-decoration: none; flex: 1;';

        const viewBtn = document.createElement('button');
        viewBtn.textContent = '表示';
        const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
        viewBtn.style.cssText = 'padding:4px 8px;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;margin-left:8px;';
        viewBtn.style.background = accentColor;
        viewBtn.onclick = () => {
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          if (isIOS) {
            window.open(f.url, '_blank', 'noopener,noreferrer');
          } else {
            showPDF(f.url, f.name, detail);
          }
        };

        fileDiv.appendChild(icon);
        fileDiv.appendChild(link);
        fileDiv.appendChild(viewBtn);
        detail.appendChild(fileDiv);
      });
    }

    if (data.content && data.content.length > 0) {
      const blocks = data.content.filter(b => b.type !== 'child_page');
      let md = '';
      blocks.forEach(b => {
        if (b.type === 'paragraph' && b.paragraph.rich_text) {
          const text = b.paragraph.rich_text.map(t => t.plain_text).join('');
          if (text.trim()) md += text + '\n\n';
        } else if (b.type === 'heading_1' && b.heading_1.rich_text) {
          const text = b.heading_1.rich_text.map(t => t.plain_text).join('');
          if (text.trim()) md += '# ' + text + '\n\n';
        } else if (b.type === 'heading_2' && b.heading_2.rich_text) {
          const text = b.heading_2.rich_text.map(t => t.plain_text).join('');
          if (text.trim()) md += '## ' + text + '\n\n';
        } else if (b.type === 'heading_3' && b.heading_3.rich_text) {
          const text = b.heading_3.rich_text.map(t => t.plain_text).join('');
          if (text.trim()) md += '### ' + text + '\n\n';
        } else if (b.type === 'bulleted_list_item' && b.bulleted_list_item.rich_text) {
          const text = b.bulleted_list_item.rich_text.map(t => t.plain_text).join('');
          if (text.trim()) md += '• ' + text + '\n';
        } else if (b.type === 'numbered_list_item' && b.numbered_list_item.rich_text) {
          const text = b.numbered_list_item.rich_text.map(t => t.plain_text).join('');
          if (text.trim()) md += '1. ' + text + '\n';
        } else if (b.type === 'table') {
          md += '\n[TABLE_START]\n';
        } else if (b.type === 'table_row' && b.table_row && b.table_row.cells) {
          const cells = b.table_row.cells.map(cell => cell.map(t => t.plain_text).join('').trim());
          md += '| ' + cells.join(' | ') + ' |\n';
        }
      });
      if (md.trim()) {
        const ct = document.createElement('h6');
        ct.textContent = 'ページ内容:';
        ct.style.cssText = 'margin:15px 0 10px 0;color:var(--text-color);font-size:14px;';
        detail.appendChild(ct);

        const textDiv = document.createElement('div');
        textDiv.className = 'child-page-text';
        textDiv.style.cssText = 'font-size:14px; line-height:1.6;';
        textDiv.innerHTML = parseMarkdownToHTML(md);
        detail.appendChild(textDiv);
      }
    }

    if ((!data.files || data.files.length === 0) && (!data.content || data.content.length === 0)) {
      detail.innerHTML = '<div style="color: #7f8c8d; font-style: italic; text-align: center; padding: 10px; font-size: 14px;">この子ページにはコンテンツがありません</div>';
    }

    button.textContent = '子ページを閉じる';
    button.style.pointerEvents = 'auto';
    button.style.opacity = '1';
    button.onclick = () => {
      detail.style.display = 'none';
      button.textContent = '子ページを表示';
      button.onclick = () => {
        detail.style.display = 'block';
        button.textContent = '子ページを閉じる';
        button.onclick = arguments.callee.caller;
      };
    };
  } catch(err) {
    button.textContent = originalText;
    button.style.pointerEvents = 'auto';
    button.style.opacity = '1';
    const detail = document.createElement('div');
    detail.className = 'child-page-details';
    detail.innerHTML = '<div style="color:#e74c3c; font-size:14px;">エラー: 子ページの詳細を取得できませんでした</div>';
    container.appendChild(detail);
  }
}

function showPDF(url, name, container) {
  const existing = container.querySelector('.pdf-viewer, .ios-pdf-viewer');
  if (existing) existing.remove();

  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

  if (isIOS || isSafari) {
    const iosViewer = document.createElement('div');
    iosViewer.className = 'ios-pdf-viewer';
    iosViewer.innerHTML = `<div class="ios-pdf-message" style="text-align:center;padding:20px;background:rgba(255,255,255,0.2);border-radius:15px;border:1px solid rgba(255,255,255,0.3);"><p style="margin-bottom:15px;color:var(--text-color);font-weight:500;">📱 ${name}</p><p style="margin-bottom:15px;color:var(--text-color);font-size:14px;">iOSデバイスではPDFを新しいタブで開きます</p><button onclick="window.open('${url}', '_blank', 'noopener,noreferrer')" style="padding:12px 20px;background:linear-gradient(135deg, rgba(255, 145, 115, 0.85) 0%, rgba(255, 138, 101, 0.85) 100%);color:white;border:none;border-radius:10px;cursor:pointer;font-size:16px;font-weight:600;border:2px solid rgba(255,255,255,0.3);backdrop-filter: blur(10px);transition: all 0.3s ease;">PDFを開く</button></div>`;
    container.appendChild(iosViewer);
  } else {
    const iframe = document.createElement('iframe');
    iframe.className = 'pdf-viewer';
    iframe.src = url;
    iframe.title = name;
    iframe.style.cssText = 'width:100%;height:400px;border:1px solid rgba(255,255,255,0.3);border-radius:15px;margin-top:15px;backdrop-filter: blur(10px);animation: fadeInUp 0.6s ease-out;';
    if (window.innerWidth >= 768) {
      iframe.style.height = '70vh';
      iframe.style.minHeight = '500px';
      iframe.style.maxWidth = '100vw';
    } else if (window.innerWidth < 480) {
      iframe.style.height = '60vh';
      iframe.style.minHeight = '';
    }
    container.appendChild(iframe);
  }
}

function parseMarkdownToHTML(markdown) {
  if (!markdown) return '';
  const lines = markdown.split('\n');
  let html = '';
  let inList=false, listType=null;
  let inTable=false, isFirstTableRow=true, tableHeaders=[];
  for (let i=0;i<lines.length;i++) {
    const line = lines[i].trim();
    if (!line) continue;
    if (line === '[TABLE_START]') {
      if (inList) { html += (listType==='ul'?'</ul>\n':'</ol>\n'); inList=false; listType=null; }
      inTable=true; isFirstTableRow=true; html += '<div class="table-container"><table>\n';
      continue;
    }
    if (line.includes('|') && line.split('|').length>2) {
      const cells = line.split('|').map(c=>c.trim()).filter(c=>c);
      if (!inTable) { if (inList) { html += (listType==='ul'?'</ul>\n':'</ol>\n'); inList=false; listType=null; } html += '<div class="table-container"><table>\n'; inTable=true; isFirstTableRow=true; }
      if (isFirstTableRow) {
        tableHeaders=cells;
        html += '<thead>\n<tr>\n';
        cells.forEach(cell => { html += `<th>${cell}</th>\n`; });
        html += '</tr>\n</thead>\n<tbody>\n';
        isFirstTableRow=false;
      } else {
        html += '<tr>\n';
        cells.forEach((cell,idx)=>{ const header=tableHeaders[idx]||''; html += `<td data-label="${header}">${cell}</td>\n`; });
        html += '</tr>\n';
      }
      continue;
    }
    if (inTable) {
      html += '</tbody></table></div>\n';
      inTable=false; isFirstTableRow=true; tableHeaders=[];
    }
    if (line.startsWith('### ')) {
      if (inList) { html += listType==='ul'?'</ul>\n':'</ol>\n'; inList=false; listType=null; }
      html += `<h3>${line.substring(4)}</h3>\n`;
    } else if (line.startsWith('## ')) {
      if (inList) { html += listType==='ul'?'</ul>\n':'</ol>\n'; inList=false; listType=null; }
      html += `<h2>${line.substring(3)}</h2>\n`;
    } else if (line.startsWith('# ')) {
      if (inList) { html += listType==='ul'?'</ul>\n':'</ol>\n'; inList=false; listType=null; }
      html += `<h1>${line.substring(2)}</h1>\n`;
    } else if (line.startsWith('• ') || line.startsWith('- ')) {
      if (!inList || listType!=='ul') { if (inList && listType==='ol') { html += '</ol>\n'; } html += '<ul>\n'; inList=true; listType='ul'; }
      html += `<li>${line.substring(2)}</li>\n`;
    } else if (/^\d+\.\s/.test(line)) {
      if (!inList || listType!=='ol') { if (inList && listType==='ul') { html += '</ul>\n'; } html += '<ol>\n'; inList=true; listType='ol'; }
      html += `<li>${line.replace(/^\d+\.\s/, '')}</li>\n`;
    } else {
      if (inList) { html += listType==='ul'?'</ul>\n':'</ol>\n'; inList=false; listType=null; }
      html += `<p>${line}</p>\n`;
    }
  }
  if (inList) html += listType==='ul'?'</ul>\n':'</ol>\n';
  if (inTable) html += '</tbody></table></div>\n';
  return html;
}
</script>
</body>
</html>
