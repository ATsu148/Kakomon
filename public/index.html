<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>ÈÅéÂéªÂïèÊ§úÁ¥¢„Ç∑„Çπ„ÉÜ„É†</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico">
  
  <!-- Google Analytics (GA4) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-13VGFN8ZFX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-13VGFN8ZFX', {
      page_title: 'Kakomon Search System',
      page_location: window.location.href
    });

    // „Ç´„Çπ„Çø„É†„Ç§„Éô„É≥„ÉàÈÄÅ‰ø°Èñ¢Êï∞
    function sendGAEvent(action, category, label, value) {
      gtag('event', action, {
        event_category: category,
        event_label: label,
        value: value
      });
    }

    // Ê§úÁ¥¢„Ç§„Éô„É≥„Éà„ÇíÈÄÅ‰ø°„Åô„ÇãÈñ¢Êï∞
    function trackSearch(searchQuery, filters) {
      gtag('event', 'search', {
        search_term: searchQuery,
        event_category: 'engagement',
        event_label: 'kakomon_search',
        custom_parameters: {
          subject_filter: filters.subject || '',
          grade_filter: filters.grade || '',
          period_filter: filters.period || ''
        }
      });
    }

    // „Éï„Ç°„Ç§„É´Èñ¢ÈÄ£„ÅÆ„Ç§„Éô„É≥„Éà„ÇíÈÄÅ‰ø°„Åô„ÇãÈñ¢Êï∞
    function trackFileAction(action, fileName, fileUrl) {
      gtag('event', action, {
        event_category: 'file_interaction',
        event_label: fileName,
        file_url: fileUrl
      });
    }

    // „Éï„Ç£„É´„Çø„ÉºÊìç‰Ωú„ÅÆ„Ç§„Éô„É≥„Éà„ÇíÈÄÅ‰ø°„Åô„ÇãÈñ¢Êï∞
    function trackFilterUsage(filterType, filterValue) {
      gtag('event', 'filter_usage', {
        event_category: 'user_interaction',
        event_label: filterType,
        filter_value: filterValue
      });
    }

    // „Éö„Éº„Ç∏Ë©≥Á¥∞Ë°®Á§∫„ÅÆ„Ç§„Éô„É≥„Éà„ÇíÈÄÅ‰ø°„Åô„ÇãÈñ¢Êï∞
    function trackPageDetailsView(pageTitle) {
      gtag('event', 'view_page_details', {
        event_category: 'content_interaction',
        event_label: pageTitle
      });
    }
  </script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html {
      overflow-x: hidden;
      scroll-behavior: smooth;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      color: #2c3e50;
      line-height: 1.6;
      overflow-x: hidden;
      position: relative;
      width: 100%;
      max-width: 100vw;
    }

    /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢„ÅÆ„Çπ„Çø„Ç§„É´ */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
      overflow: hidden;
    }

    /* „É≠„Éº„Éá„Ç£„É≥„Ç∞„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Çπ„Çø„Ç§„É´ */
    .loading-text {
      margin-top: 40px;
      color: #2c3e50;
      font-size: 1.2rem;
      font-weight: 500;
      text-align: center;
      opacity: 0;
      animation: fadeInText 1s ease-in-out 0.5s forwards;
      letter-spacing: 0.5px;
    }

    @keyframes fadeInText {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .loading-screen.hidden {
      opacity: 0;
      visibility: hidden;
    }

    /* Ê≠£ËëâÊõ≤Á∑ö„É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
    .rose-loading-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden; /* „ÇØ„É™„ÉÉ„Éî„É≥„Ç∞„ÇíÂà∂Âæ° */
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    /* Â∞èÁîªÈù¢Âêë„Åë„Çπ„Éî„Éä„Éº */
    .spinner-container {
      display: none;
      flex-direction: column;
      align-items: center;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(44, 62, 80, 0.3);
      border-top-color: #ff7043;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .spinner-text {
      color: #2c3e50;
      font-size: 1.1rem;
      font-weight: 500;
      text-align: center;
      letter-spacing: 0.5px;
    }

    #roseSVG {
      width: 450px;
      height: 450px;
      max-width: 90vmin;
      max-height: 90vmin;
      background: transparent;
    }

    /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú - SVG„Çµ„Ç§„Ç∫Ë™øÊï¥ */
    @media (max-width: 480px) {
      #roseSVG {
        width: 350px;
        height: 350px;
        max-width: 80vmin;
        max-height: 80vmin;
      }

      .rose-loading-container {
        display: none;
      }

      .spinner-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100vw;
        height: 100vh;
        flex-direction: column;
      }
    }

    @media (min-width: 481px) and (max-width: 1024px) {
      #roseSVG {
        width: 400px;
        height: 400px;
        max-width: 85vmin;
        max-height: 85vmin;
      }
    }

    @media (min-width: 1025px) {
      #roseSVG {
        width: 450px;
        height: 450px;
        max-width: 90vmin;
        max-height: 90vmin;
      }
    }

    /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅØÊúÄÂàù„ÅØÈùûË°®Á§∫ */
    .main-content {
      opacity: 0;
      transition: opacity 0.8s ease-out;
    }

    .main-content.visible {
      opacity: 1;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><radialGradient id="grain"><stop offset="0%" stop-color="white" stop-opacity="0.1"/><stop offset="100%" stop-color="transparent"/></radialGradient></defs><circle cx="50" cy="50" r="1" fill="url(%23grain)"/></svg>') repeat;
      pointer-events: none;
      opacity: 0.1;
      z-index: -1;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      animation: fadeInUp 0.8s ease-out;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }
    
    @keyframes float {
      0%, 100% {
        transform: translateY(0px);
      }
      50% {
        transform: translateY(-5px);
      }
    }
    
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #2c3e50 0%, #4a5568 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 4px 8px rgba(0,0,0,0.1);
      animation: slideIn 1s ease-out 0.2s both;
    }
    
    .search-box {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 30px;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.3);
      animation: slideIn 1s ease-out 0.4s both;
      transition: all 0.3s ease;
    }
    
    .search-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(31, 38, 135, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.4);
    }
    
    #searchInput {
      padding: 16px 20px;
      border: 2px solid rgba(255, 255, 255, 0.4);
      border-radius: 15px;
      font-size: 16px;
      background: rgba(255, 255, 255, 0.95);
      color: #2c3e50;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    #searchInput:focus {
      outline: none;
      border-color: rgba(255, 145, 115, 0.6);
      background: rgba(255, 255, 255, 1);
      box-shadow: 0 0 20px rgba(255, 145, 115, 0.2);
      transform: scale(1.02);
    }
    
    #searchInput::placeholder {
      color: #718096;
    }
    
    button {
      background: linear-gradient(135deg, rgba(255, 145, 115, 0.85) 0%, rgba(255, 138, 101, 0.85) 100%);
      color: white;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      min-height: 50px;
      touch-action: manipulation;
      transition: all 0.3s ease;
      position: relative;
      backdrop-filter: blur(10px);
      overflow: hidden;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s ease;
    }
    
    button:hover::before {
      left: 100%;
    }
    
    button:hover, button:active {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 145, 115, 0.3);
      background: linear-gradient(135deg, rgba(255, 134, 101, 0.9) 0%, rgba(255, 114, 86, 0.9) 100%);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    /* „Çø„Éñ„É¨„ÉÉ„Éà‰ª•‰∏ä„ÅÆ„Çµ„Ç§„Ç∫ */
    @media (min-width: 768px) {
      body {
        padding: 0;
      }
      .container {
        padding: 40px;
      }
      h1 {
        font-size: 3.5rem;
        margin-bottom: 40px;
      }
      .search-box {
        flex-direction: row;
        align-items: stretch;
        padding: 30px;
      }
      #searchInput {
        flex: 1;
        margin-right: 15px;
        font-size: 18px;
        padding: 18px 24px;
      }
      button {
        padding: 0 30px;
        font-size: 18px;
        min-width: 120px;
      }
    }
    
    .result-item {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      margin: 15px 0;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
      animation: slideIn 0.6s ease-out;
    }
    
    .result-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 40px rgba(31, 38, 135, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.4);
    }
    
    .result-title {
      font-size: 18px;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 15px;
      cursor: pointer;
      line-height: 1.4;
      min-height: 44px;
      display: flex;
      align-items: center;
      transition: all 0.3s ease;
    }
    
    .result-title:hover, .result-title:active {
      color: #667eea;
      text-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    }
    
    .result-meta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    
    .meta-item {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 4px 12px rgba(31, 38, 135, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .meta-item:hover {
      transform: scale(1.05);
      background: rgba(255, 255, 255, 0.6);
      box-shadow: 0 6px 16px rgba(31, 38, 135, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    /* „Çø„Éñ„É¨„ÉÉ„Éà‰ª•‰∏ä„ÅÆ„Çµ„Ç§„Ç∫ */
    @media (min-width: 768px) {
      .result-item {
        margin: 20px 0;
        padding: 25px;
      }
      .result-title {
        font-size: 20px;
        min-height: auto;
      }
      .result-meta {
        gap: 15px;
      }
      .meta-item {
        padding: 6px 10px;
        font-size: 14px;
      }
    }
    
    .subject {
      background: rgba(212, 237, 218, 0.8);
      color: #155724;
      border-color: rgba(21, 87, 36, 0.3);
    }
    .grade {
      background: rgba(204, 229, 255, 0.8);
      color: #004085;
      border-color: rgba(0, 64, 133, 0.3);
    }
    .period {
      background: rgba(226, 212, 255, 0.8);
      color: #4b0082;
      border-color: rgba(75, 0, 130, 0.3);
    }
    
    .files-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.3);
      animation: fadeInUp 0.6s ease-out;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 15px;
      margin: 10px 0;
      transition: all 0.3s ease;
      backdrop-filter: blur(15px);
      box-shadow: 0 4px 12px rgba(31, 38, 135, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .file-item:hover {
      background: rgba(255, 255, 255, 0.5);
      transform: translateX(5px);
      box-shadow: 0 6px 16px rgba(31, 38, 135, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    .pdf-icon {
      color: #ff6b6b;
      font-weight: bold;
      font-size: 20px;
      animation: float 3s ease-in-out infinite;
    }
    
    .file-link {
      color: #2c3e50;
      text-decoration: none;
      flex: 1;
      font-size: 15px;
      min-height: 44px;
      display: flex;
      align-items: center;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .file-link:hover, .file-link:active {
      text-decoration: underline;
      color: rgba(255, 145, 115, 0.9);
    }
    
    .file-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .file-btn {
      padding: 10px 14px;
      background: linear-gradient(135deg, rgba(255, 167, 132, 0.8) 0%, rgba(255, 152, 121, 0.8) 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      min-height: 40px;
      white-space: nowrap;
      font-weight: 600;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(8px);
    }
    
    .file-btn.open-tab {
      background: linear-gradient(135deg, rgba(255, 193, 125, 0.8) 0%, rgba(255, 183, 107, 0.8) 100%);
    }
    
    /* Â≠ê„Éö„Éº„Ç∏Èñ¢ÈÄ£„ÅÆ„Çπ„Çø„Ç§„É´ */
    .child-page-item {
      margin: 15px 0;
      padding: 22px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 100%);
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(15px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .child-page-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(135deg, #ff9173 0%, #ff8a65 100%);
      border-radius: 0 2px 2px 0;
    }
    

    
    .child-page-item h5 {
      margin: 0 0 12px 0;
      color: #2c3e50;
      font-size: 17px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .child-page-item h5::before {
      content: 'üìÑ';
      font-size: 14px;
    }
    
    .child-page-details {
      margin-top: 20px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(255, 145, 115, 0.08) 0%, rgba(255, 138, 101, 0.05) 100%);
      border-radius: 12px;
      border: 1px solid rgba(255, 145, 115, 0.15);
      animation: slideInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), 0 4px 15px rgba(255, 145, 115, 0.08);
      position: relative;
    }
    
    .child-page-details::before {
      content: '';
      position: absolute;
      top: -1px;
      left: -1px;
      right: -1px;
      bottom: -1px;
      background: linear-gradient(135deg, rgba(255, 145, 115, 0.2) 0%, rgba(255, 138, 101, 0.1) 100%);
      border-radius: 12px;
      z-index: -1;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    

    
    @keyframes slideInUp {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .child-file-item {
      display: flex;
      align-items: center;
      margin: 12px 0;
      padding: 12px 15px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 100%);
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .child-file-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 3px;
      height: 100%;
      background: linear-gradient(135deg, #ff9173 0%, #ff8a65 100%);
      border-radius: 0 2px 2px 0;
    }
    

    
    .child-page-text {
      font-size: 14px;
      line-height: 1.7;
      color: #34495e;
    }
    
    .child-page-text h1, .child-page-text h2, .child-page-text h3 {
      margin: 16px 0 10px 0;
      color: #2c3e50;
      font-weight: 600;
    }
    
    .child-page-text h1 { 
      font-size: 18px; 
      border-bottom: 2px solid rgba(255, 145, 115, 0.3);
      padding-bottom: 4px;
    }
    .child-page-text h2 { 
      font-size: 16px; 
      border-bottom: 1px solid rgba(255, 145, 115, 0.2);
      padding-bottom: 3px;
    }
    .child-page-text h3 { 
      font-size: 15px; 
    }
    
    .child-page-text p {
      margin: 10px 0;
      color: #2c3e50;
      text-align: justify;
    }
    
    .child-page-text ul, .child-page-text ol {
      margin: 12px 0;
      padding-left: 24px;
    }
    
    .child-page-text li {
      margin: 6px 0;
      color: #2c3e50;
    }
    
    .child-page-text table {
      width: max-content;
      min-width: 100%;
      border-collapse: collapse;
      margin: 0;
      font-size: 13px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      overflow: visible;
      box-shadow: none;
      border: none;
      white-space: nowrap;
    }

    /* Â≠ê„Éö„Éº„Ç∏Áî®„ÅÆ„ÉÜ„Éº„Éñ„É´„Ç≥„É≥„ÉÜ„Éä */
    .child-page-text .table-container {
      margin: 15px 0;
      border: 2px solid rgba(44, 62, 80, 0.3);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .child-page-text th, .child-page-text td {
      border: 1px solid rgba(44, 62, 80, 0.25);
      padding: 10px 12px;
      text-align: left;
      white-space: nowrap;
    }
    
    .child-page-text th {
      background: linear-gradient(135deg, rgba(255, 145, 115, 0.25) 0%, rgba(255, 138, 101, 0.2) 100%);
      font-weight: 600;
      color: #2c3e50;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.5px;
      border-bottom: 2px solid rgba(44, 62, 80, 0.3);
    }
    
    .child-page-text td {
      background: rgba(255, 255, 255, 0.05);
      color: #34495e;
    }
    
    .child-page-text tr:nth-child(even) td {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .file-btn:hover, .file-btn:active {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .pdf-viewer {
      width: 100%;
      height: 400px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 15px;
      margin-top: 15px;
      backdrop-filter: blur(10px);
      animation: fadeInUp 0.6s ease-out;
    }

    .ios-pdf-viewer {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 15px;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .ios-pdf-message button:hover {
      opacity: 0.8;
      transform: translateY(-1px);
    }

    .ios-pdf-message button:active {
      transform: translateY(0);
    }
    
    .page-content {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      padding: 25px;
      margin: 15px 0;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.3);
      animation: fadeInUp 0.6s ease-out;
    }
    
    .page-content h4 {
      margin-top: 0;
      color: #2c3e50;
      font-weight: 600;
      margin-bottom: 20px;
      font-size: 1.2rem;
      border-bottom: 2px solid rgba(44, 62, 80, 0.2);
      padding-bottom: 10px;
    }
    
    .page-text {
      line-height: 1.7;
      color: #2c3e50;
    }
    
    .page-text h1 {
      font-size: 1.6em;
      font-weight: bold;
      margin: 1em 0 0.5em 0;
      color: #2c3e50;
      border-bottom: 2px solid rgba(44, 62, 80, 0.3);
      padding-bottom: 0.3em;
    }
    
    .page-text h2 {
      font-size: 1.4em;
      font-weight: bold;
      margin: 1em 0 0.5em 0;
      color: #2c3e50;
      border-bottom: 1px solid rgba(44, 62, 80, 0.2);
      padding-bottom: 0.2em;
    }
    
    .page-text h3 {
      font-size: 1.2em;
      font-weight: bold;
      margin: 1em 0 0.5em 0;
      color: #2c3e50;
    }
    
    .page-text p {
      margin: 0.8em 0;
    }
    
    .page-text ul, .page-text ol {
      margin: 0.8em 0;
      padding-left: 1.5em;
    }
    
    .page-text li {
      margin: 0.3em 0;
    }
    
    .page-text table {
      border-collapse: collapse;
      width: max-content;
      min-width: 100%;
      margin: 0;
      border: none;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(5px);
      border-radius: 10px;
      overflow: visible;
      white-space: nowrap;
    }

    /* „ÉÜ„Éº„Éñ„É´Áî®„ÅÆÊ®™„Çπ„ÇØ„É≠„Éº„É´„Ç≥„É≥„ÉÜ„Éä */
    .table-container {
      overflow-x: auto;
      margin: 1em 0;
      border-radius: 10px;
      border: 2px solid rgba(44, 62, 80, 0.4);
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(5px);
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 145, 115, 0.6) rgba(255, 255, 255, 0.3);
    }
    
    .table-container::-webkit-scrollbar {
      height: 8px;
    }
    
    .table-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }
    
    .table-container::-webkit-scrollbar-thumb {
      background: rgba(255, 145, 115, 0.6);
      border-radius: 4px;
    }
    
    .table-container::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 145, 115, 0.8);
    }
    
    .page-text th,
    .page-text td {
      border: 1px solid rgba(44, 62, 80, 0.3);
      padding: 12px 15px;
      text-align: left;
      white-space: nowrap;
    }
    
    .page-text th {
      background: rgba(255, 145, 115, 0.8);
      font-weight: bold;
      color: #2c3e50;
      border-bottom: 2px solid rgba(44, 62, 80, 0.4);
    }
    
    .page-text tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .page-text tr:nth-child(odd) {
      background: rgba(255, 255, 255, 0.1);
    }

    /* ÁîªÈù¢ÂπÖ„Åå480pxÊú™Ê∫Ä„ÅÆÂ†¥Âêà„ÅÆPDFË°®Á§∫ */
    @media (max-width: 479px) {
      .pdf-viewer {
        height: 60vh;
        min-height: 0;
      }
    }
    
    /* „Çø„Éñ„É¨„ÉÉ„Éà‰ª•‰∏ä„ÅÆ„Çµ„Ç§„Ç∫ */
    @media (min-width: 768px) {
      .file-item {
        padding: 12px;
      }
      .file-link {
        min-height: auto;
      }
      .file-btn {
        min-height: auto;
      }
      .pdf-viewer {
        height: 70vh;
        min-height: 500px;
        max-width: 100vw;
      }

      .ios-pdf-viewer {
        margin: 10px 0;
        padding: 10px;
      }

      .ios-pdf-message {
        font-size: 14px;
      }

      .ios-pdf-message button {
        font-size: 14px !important;
        padding: 10px 16px !important;
      }
      .page-content {
        padding: 25px;
      }
    }
    
    .loading {
      text-align: center;
      color: #2c3e50;
      padding: 30px;
      font-size: 18px;
      font-weight: 500;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      border: 1px solid rgba(44, 62, 80, 0.2);
      backdrop-filter: blur(10px);
      animation: pulse 2s ease-in-out infinite;
    }
    
    .error {
      color: #ff6b6b;
      background: rgba(248, 215, 218, 0.15);
      backdrop-filter: blur(10px);
      padding: 15px;
      border-radius: 15px;
      margin: 15px 0;
      border: 1px solid rgba(220, 53, 69, 0.3);
      animation: slideIn 0.6s ease-out;
    }
    
    .filters {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 30px;
      padding: 25px;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.3);
      animation: slideIn 1s ease-out 0.6s both;
      transition: all 0.3s ease;
    }
    
    .filters:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(31, 38, 135, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.4);
    }
    
    .filter-row {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      transition: all 0.3s ease;
    }
    
    .filter-group:hover {
      transform: translateY(-2px);
    }
    
    .filter-label {
      font-size: 15px;
      font-weight: 600;
      color: #2c3e50;
      text-shadow: 0 1px 2px rgba(255,255,255,0.5);
      margin-bottom: 8px;
      display: block;
      transition: all 0.3s ease;
    }
    
    .filter-group:hover .filter-label {
      color: rgba(255, 145, 115, 0.9);
      transform: translateY(-1px);
    }
    
    select {
      padding: 14px 20px;
      border: 2px solid rgba(255, 255, 255, 0.4);
      border-radius: 15px;
      font-size: 16px;
      background: rgba(255, 255, 255, 0.9);
      color: #2c3e50;
      min-height: 50px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      transition: all 0.3s ease;
      backdrop-filter: blur(15px);
      box-shadow: 0 4px 12px rgba(31, 38, 135, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.3);
      cursor: pointer;
      position: relative;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23718096' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 16px;
      padding-right: 45px;
    }
    
    select:focus {
      outline: none;
      border-color: rgba(255, 145, 115, 0.6);
      background: rgba(255, 255, 255, 1);
      box-shadow: 0 0 20px rgba(255, 145, 115, 0.2), 0 6px 20px rgba(31, 38, 135, 0.15);
      transform: scale(1.02);
    }
    
    select:hover {
      border-color: rgba(255, 145, 115, 0.4);
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 6px 16px rgba(31, 38, 135, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.4);
      transform: translateY(-1px);
    }
    
    /* Firefox„ÅÆSelect„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÅÆ„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ */
    select option {
      background: rgba(255, 255, 255, 0.95);
      color: #2c3e50;
      padding: 12px 16px;
      font-size: 16px;
      border: none;
      backdrop-filter: blur(10px);
    }
    
    select option:hover,
    select option:focus,
    select option:checked {
      background: rgba(255, 145, 115, 0.2);
      color: #2c3e50;
    }
    
    /* Webkit„Éô„Éº„Çπ„ÅÆ„Éñ„É©„Ç¶„Ç∂ÔºàChrome, SafariÔºâ„Åß„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„Çπ„Çø„Ç§„É´ */
    @supports (-webkit-appearance: none) {
      select {
        background-color: rgba(255, 255, 255, 0.9);
      }
    }
    
    .clear-filters {
      padding: 14px 20px;
      background: linear-gradient(135deg, rgba(255, 158, 128, 0.85) 0%, rgba(255, 138, 101, 0.85) 100%);
      color: white;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      min-height: 50px;
      backdrop-filter: blur(10px);
      margin-top: 15px;
      transition: all 0.3s ease;
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 12px rgba(31, 38, 135, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
    }
    
    .clear-filters::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s ease;
    }
    
    .clear-filters:hover::before {
      left: 100%;
    }
    
    .clear-filters:hover, .clear-filters:active {
      background: linear-gradient(135deg, rgba(255, 134, 101, 0.9) 0%, rgba(255, 114, 86, 0.9) 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 145, 115, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    .clear-filters:active {
      transform: translateY(0);
    }
    
    .pagination-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    /* „Çø„Éñ„É¨„ÉÉ„Éà‰ª•‰∏ä„ÅÆ„Çµ„Ç§„Ç∫ */
    @media (min-width: 768px) {
      .filters {
        flex-direction: row;
        align-items: flex-end;
        flex-wrap: wrap;
        padding: 30px;
      }
      .filter-row {
        flex-direction: row;
        flex: 1;
      }
      select {
        padding: 12px 20px;
        font-size: 16px;
        min-height: auto;
        padding-right: 45px;
      }
      .clear-filters {
        padding: 12px 20px;
        min-height: auto;
        margin-top: 0;
        align-self: flex-end;
      }
    }

    /* „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥Âêë„Åë„ÅÆËøΩÂä†„Çπ„Çø„Ç§„É´ */
    @media (max-width: 767px) {
      h1 {
        font-size: 2rem;
      }
      
      .search-box {
        padding: 20px;
        gap: 12px;
      }
      
      #searchInput {
        padding: 14px 16px;
        font-size: 16px;
      }
      
      button {
        padding: 14px 20px;
        font-size: 16px;
      }
      
      .result-item {
        padding: 15px;
        margin: 10px 0;
      }
      
      .result-title {
        font-size: 16px;
      }
      
      .meta-item {
        padding: 6px 10px;
        font-size: 12px;
      }
      
      .file-item {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      
      .file-actions {
        width: 100%;
        justify-content: space-between;
      }
      
      .file-btn {
        flex: 1;
        text-align: center;
      }

      /* „ÉÜ„Éº„Éñ„É´„Çí„É¢„Éê„Ç§„É´Âêë„Åë„Å´„Ç§„É≥„É©„Ç§„É≥Ë°®Á§∫ */
      .page-text table,
      .child-page-text table {
        border: 0;
      }
      .page-text thead,
      .child-page-text thead {
        display: none;
      }
      .page-text tr,
      .child-page-text tr {
        display: block;
        margin-bottom: 10px;
        border-bottom: 1px solid rgba(44, 62, 80, 0.3);
      }
      .page-text td,
      .child-page-text td {
        display: flex;
        justify-content: space-between;
        width: 100%;
        padding: 8px 10px;
      }
      .page-text td::before,
      .child-page-text td::before {
        content: attr(data-label);
        font-weight: bold;
        margin-right: 8px;
      }
      
      .filters {
        padding: 20px;
        gap: 15px;
      }
      
      .filter-group {
        gap: 6px;
      }
      
      select {
        padding: 12px;
        font-size: 16px;
      }

      /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢„ÅÆË™øÊï¥ */
      .loading-screen {
        background: linear-gradient(135deg, #F9FAFB 0%, #FFF5F5 100%);
      }
    }

    /* ‰∏≠ÁîªÈù¢„Éá„Éê„Ç§„ÇπÂêë„ÅëË™øÊï¥ */
    @media (min-width: 768px) and (max-width: 1024px) {
      .container {
        padding: 30px;
      }
      
      h1 {
        font-size: 3rem;
      }
      
      .loading-screen {
        background: linear-gradient(135deg, #F9FAFB 0%, #FFF5F5 100%);
      }
    }

    /* Â§ßÁîªÈù¢„Éá„Éê„Ç§„ÇπÂêë„ÅëË™øÊï¥ */
    @media (min-width: 1025px) {
      .container {
        padding: 40px;
      }
      
      h1 {
        font-size: 3.5rem;
      }
      
      /* È´òËß£ÂÉèÂ∫¶„Éá„Ç£„Çπ„Éó„É¨„Ç§„Åß„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂìÅË≥™Âêë‰∏ä */
      .loading-screen {
        background: linear-gradient(135deg, #F9FAFB 0%, #FFF5F5 100%);
      }
      
      #roseSVG {
        image-rendering: crisp-edges;
        image-rendering: -webkit-optimize-contrast;
      }
    }

    /* ËøΩÂä†„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
    .result-item:nth-child(even) {
      animation-delay: 0.1s;
    }
    
    .result-item:nth-child(odd) {
      animation-delay: 0.2s;
    }
    
    /* „É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(44, 62, 80, 0.3);
      border-radius: 50%;
      border-top-color: #2c3e50;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }

    /* SinÊ≥¢„É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
    .wave-loading-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    #waveCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #F9FAFB;
    }
  </style>
</head>
<body>
  <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢ -->
  <div id="loadingScreen" class="loading-screen">
    <div class="rose-loading-container">
      <svg id="roseSVG" viewBox="-400 -400 800 800" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <!-- ÊöñËâ≤Á≥ª„É°„Ç§„É≥„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ -->
          <linearGradient id="roseGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#ff7043;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#ff8a65;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#ffab91;stop-opacity:1" />
          </linearGradient>
          
          <!-- 3D„Ç∑„É£„Éâ„Ç¶Áî®„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ -->
          <linearGradient id="shadowGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#d84315;stop-opacity:0.4" />
            <stop offset="100%" style="stop-color:#bf360c;stop-opacity:0.2" />
          </linearGradient>
          
          <!-- „Éè„Ç§„É©„Ç§„ÉàÁî®„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ -->
          <linearGradient id="highlightGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.8" />
            <stop offset="100%" style="stop-color:#fff3e0;stop-opacity:0.4" />
          </linearGradient>
          
          <!-- „ÇΩ„Éï„Éà„Éñ„É©„Éº„Éï„Ç£„É´„Çø„Éº -->
          <filter id="softBlur" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur in="SourceGraphic" stdDeviation="1"/>
            <feColorMatrix type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 1.2 0"/>
          </filter>
          
          <!-- „Ç∞„É≠„ÉºÂäπÊûú -->
          <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
            <feMerge> 
              <feMergeNode in="coloredBlur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>
        
        <!-- „Ç∑„É£„Éâ„Ç¶„É¨„Ç§„É§„ÉºÔºàÂ••Ë°å„ÅçÊÑü„ÅÆ„Åü„ÇÅÔºâ -->
        <path id="roseShadowPath" d="" stroke="url(#shadowGradient)" stroke-width="3" fill="none" 
              stroke-linecap="round" stroke-linejoin="round" opacity="0.3" 
              transform="translate(2, 2)" style="filter: url(#softBlur)"/>
        
        <!-- „É°„Ç§„É≥„Éë„Çπ -->
        <path id="rosePath" d="" stroke="url(#roseGradient)" stroke-width="2.5" fill="none" 
              stroke-linecap="round" stroke-linejoin="round" style="filter: url(#glow)"/>
        
        <!-- „Éè„Ç§„É©„Ç§„Éà„É¨„Ç§„É§„ÉºÔºàÂÖâ„ÅÆÂèçÂ∞ÑÊÑüÔºâ -->
        <path id="roseHighlightPath" d="" stroke="url(#highlightGradient)" stroke-width="1" fill="none" 
              stroke-linecap="round" stroke-linejoin="round" opacity="0.6" 
              transform="translate(-1, -1)" style="filter: url(#softBlur)"/>
      </svg>
    </div>
    <div class="spinner-container" id="spinnerContainer">
      <div class="spinner"></div>
      <div class="spinner-text">ÈÅéÂéªÂïè„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
    </div>
  </div>

  <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
  <div id="mainContent" class="main-content">
    <div class="container">
    <h1>ÈÅéÂéªÂïèÊ§úÁ¥¢„Ç∑„Çπ„ÉÜ„É†</h1>
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="ÁßëÁõÆÂêç„ÇÑ„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" />
      <button onclick="search()">Ê§úÁ¥¢</button>
    </div>
    
    <!-- „Éï„Ç£„É´„Çø„Çª„ÇØ„Ç∑„Éß„É≥ -->
    <div class="filters">
      <div class="filter-row">
        <div class="filter-group">
          <label class="filter-label">ÊïôÁßë</label>
          <select id="subjectFilter" onchange="onFilterChange('subject', this.value)">
            <option value="">„Åô„Åπ„Å¶</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Â≠¶Âπ¥</label>
          <select id="gradeFilter" onchange="onFilterChange('grade', this.value)">
            <option value="">„Åô„Åπ„Å¶</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">ÊôÇÊúü</label>
          <select id="periodFilter" onchange="onFilterChange('period', this.value)">
            <option value="">„Åô„Åπ„Å¶</option>
          </select>
        </div>
      </div>
      <button class="clear-filters" onclick="clearFilters()">„Éï„Ç£„É´„Çø„Çí„ÇØ„É™„Ç¢</button>
    </div>
    
    <div id="results"></div>
  </div>

  <script>
    // „Éï„Ç£„É´„Çø„Ç™„Éó„Ç∑„Éß„É≥„ÇíÊ†ºÁ¥ç„Åô„ÇãÂ§âÊï∞
    let filterOptions = {
      subjects: new Set(),
      grades: new Set(),
      periods: new Set()
    };

    // „Éö„Éº„Ç∏Ë©≥Á¥∞„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•
    const pageDetailsCache = new Map();

    // „Éó„É™„É≠„Éº„ÉâÁî®„ÅÆ„Ç≠„É•„Éº„Å®ÂêåÊôÇÂÆüË°åÊï∞Âà∂Èôê
    const preloadQueue = [];
    let activePreloads = 0;
    const MAX_CONCURRENT_PRELOADS = 3;

    function schedulePreload(pageId) {
      if (pageDetailsCache.has(pageId) || preloadQueue.includes(pageId)) {
        return;
      }
      preloadQueue.push(pageId);
      runNextPreload();
    }

    function runNextPreload() {
      if (activePreloads >= MAX_CONCURRENT_PRELOADS || preloadQueue.length === 0) {
        return;
      }
      const id = preloadQueue.shift();
      activePreloads++;
      preloadPageDetails(id).finally(() => {
        activePreloads--;
        runNextPreload();
      });
    }

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const id = entry.target.dataset.pageId;
          if (id) schedulePreload(id);
          observer.unobserve(entry.target);
        }
      });
    });

    // „Éá„Éº„Çø„ÇíÊï¥ÁêÜ„Åó„Å¶Ë°®Á§∫„Åô„ÇãÈñ¢Êï∞
    function formatProperty(property) {
      if (property.type === 'title') {
        return property.title.map(t => t.plain_text).join('');
      } else if (property.type === 'multi_select') {
        return property.multi_select.map(s => s.name).join(', ');
      } else if (property.type === 'select' && property.select) {
        return property.select.name;
      } else if (property.type === 'date' && property.date) {
        return property.date.start;
      } else if (property.type === 'number' && property.number !== null) {
        return property.number.toString();
      } else if (property.type === 'rich_text') {
        return property.rich_text.map(t => t.plain_text).join('');
      }
      return '';
    }

    // ÂÆüÈöõ„Å´„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Åå„ÅÇ„Çã„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
    function hasActualContent(content) {
      if (!content || content.length === 0) return false;
      
      // Â≠ê„Éö„Éº„Ç∏„Éñ„É≠„ÉÉ„ÇØ„ÇíÈô§Â§ñ„Åó„Å¶„Åã„Çâ„ÉÅ„Çß„ÉÉ„ÇØ
      const nonChildPageContent = content.filter(block => block.type !== 'child_page');
      
      for (const block of nonChildPageContent) {
        if (block.type === 'paragraph' && block.paragraph.rich_text) {
          const text = block.paragraph.rich_text.map(text => text.plain_text).join('').trim();
          if (text) return true;
        } else if (block.type === 'heading_1' && block.heading_1.rich_text) {
          const text = block.heading_1.rich_text.map(text => text.plain_text).join('').trim();
          if (text) return true;
        } else if (block.type === 'heading_2' && block.heading_2.rich_text) {
          const text = block.heading_2.rich_text.map(text => text.plain_text).join('').trim();
          if (text) return true;
        } else if (block.type === 'heading_3' && block.heading_3.rich_text) {
          const text = block.heading_3.rich_text.map(text => text.plain_text).join('').trim();
          if (text) return true;
        } else if (block.type === 'bulleted_list_item' && block.bulleted_list_item.rich_text) {
          const text = block.bulleted_list_item.rich_text.map(text => text.plain_text).join('').trim();
          if (text) return true;
        } else if (block.type === 'numbered_list_item' && block.numbered_list_item.rich_text) {
          const text = block.numbered_list_item.rich_text.map(text => text.plain_text).join('').trim();
          if (text) return true;
        } else if (block.type === 'table_row' && block.table_row && block.table_row.cells) {
          const hasContent = block.table_row.cells.some(cell => 
            cell.some(text => text.plain_text.trim())
          );
          if (hasContent) return true;
        }
      }
      return false;
    }

    // Markdown„ÉÜ„Ç≠„Çπ„Éà„ÇíËß£Êûê„Åó„Å¶HTML„Å´Â§âÊèõ„Åô„ÇãÈñ¢Êï∞
    function parseMarkdownToHTML(markdown) {
      if (!markdown) return '';
      
      // Ë°å„Åî„Å®„Å´ÂàÜÂâ≤
      const lines = markdown.split('\n');
      let html = '';
      let inList = false;
      let listType = null;
      let inTable = false;
      let isFirstTableRow = true;
      let tableHeaders = [];
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const trimmedLine = line.trim();
        
        if (!trimmedLine) {
          continue;
        }
        
        // „ÉÜ„Éº„Éñ„É´ÈñãÂßã„Éû„Éº„Ç´„Éº„ÅÆÂá¶ÁêÜ
        if (trimmedLine === '[TABLE_START]') {
          if (inList) {
            html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
            inList = false;
            listType = null;
          }
          inTable = true;
          isFirstTableRow = true;
          html += '<div class="table-container"><table>\n';
          continue;
        }
        
        // „ÉÜ„Éº„Éñ„É´Ë°å„ÅÆÊ§úÂá∫Ôºà|„ÅßÂå∫Âàá„Çâ„Çå„ÅüË°åÔºâ
        if (trimmedLine.includes('|') && trimmedLine.split('|').length > 2) {
          const cells = trimmedLine.split('|').map(cell => cell.trim()).filter(cell => cell);
          
          if (!inTable) {
            // „ÉÜ„Éº„Éñ„É´ÈñãÂßã
            if (inList) {
              html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
              inList = false;
              listType = null;
            }
            html += '<div class="table-container"><table>\n';
            inTable = true;
            isFirstTableRow = true;
          }
          
          if (isFirstTableRow) {
            tableHeaders = cells;
            html += '<thead>\n<tr>\n';
            cells.forEach(cell => {
              html += `<th>${cell}</th>\n`;
            });
            html += '</tr>\n</thead>\n<tbody>\n';
            isFirstTableRow = false;
          } else {
            html += '<tr>\n';
            cells.forEach((cell, idx) => {
              const header = tableHeaders[idx] || '';
              html += `<td data-label="${header}">${cell}</td>\n`;
            });
            html += '</tr>\n';
          }
          continue;
        }
        
        // „ÉÜ„Éº„Éñ„É´‰ª•Â§ñ„ÅÆÂá¶ÁêÜ„ÅÆÂ†¥Âêà„ÄÅ„ÉÜ„Éº„Éñ„É´„ÇíÁµÇ‰∫Ü
        if (inTable) {
          html += '</tbody></table></div>\n';
          inTable = false;
          isFirstTableRow = true;
          tableHeaders = [];
        }
        
        // Ë¶ãÂá∫„Åó
        if (trimmedLine.startsWith('### ')) {
          if (inList) {
            html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
            inList = false;
            listType = null;
          }
          html += `<h3>${trimmedLine.substring(4)}</h3>\n`;
        } else if (trimmedLine.startsWith('## ')) {
          if (inList) {
            html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
            inList = false;
            listType = null;
          }
          html += `<h2>${trimmedLine.substring(3)}</h2>\n`;
        } else if (trimmedLine.startsWith('# ')) {
          if (inList) {
            html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
            inList = false;
            listType = null;
          }
          html += `<h1>${trimmedLine.substring(2)}</h1>\n`;
        }
        // ÁÆáÊù°Êõ∏„Åç
        else if (trimmedLine.startsWith('‚Ä¢ ') || trimmedLine.startsWith('- ')) {
          if (!inList || listType !== 'ul') {
            if (inList && listType === 'ol') {
              html += '</ol>\n';
            }
            html += '<ul>\n';
            inList = true;
            listType = 'ul';
          }
          html += `<li>${trimmedLine.substring(2)}</li>\n`;
        }
        // Áï™Âè∑‰ªò„Åç„É™„Çπ„Éà
        else if (/^\d+\.\s/.test(trimmedLine)) {
          if (!inList || listType !== 'ol') {
            if (inList && listType === 'ul') {
              html += '</ul>\n';
            }
            html += '<ol>\n';
            inList = true;
            listType = 'ol';
          }
          html += `<li>${trimmedLine.replace(/^\d+\.\s/, '')}</li>\n`;
        }
        // ÈÄöÂ∏∏„ÅÆÊÆµËêΩ
        else {
          if (inList) {
            html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
            inList = false;
            listType = null;
          }
          html += `<p>${trimmedLine}</p>\n`;
        }
      }
      
      // ÊúÄÂæå„Å´„É™„Çπ„Éà„ÇÑ„ÉÜ„Éº„Éñ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈñâ„Åò„Çã
      if (inList) {
        html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
      }
      if (inTable) {
        html += '</tbody></table></div>\n';
      }
      
      return html;
    }

    function populateFilterOptions(selectId, options) {
      const select = document.getElementById(selectId);
      // Êó¢Â≠ò„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥Ôºà"„Åô„Åπ„Å¶"‰ª•Â§ñÔºâ„Çí„ÇØ„É™„Ç¢
      while (select.children.length > 1) {
        select.removeChild(select.lastChild);
      }
      
      // Êñ∞„Åó„ÅÑ„Ç™„Éó„Ç∑„Éß„É≥„ÇíËøΩÂä†
      options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        select.appendChild(optionElement);
      });
    }

    function clearFilters() {
      // Google Analytics: „Éï„Ç£„É´„Çø„Éº„ÇØ„É™„Ç¢„Ç§„Éô„É≥„Éà„ÇíËøΩË∑°
      sendGAEvent('clear_filters', 'user_interaction', 'filter_controls');
      
      document.getElementById('subjectFilter').value = '';
      document.getElementById('gradeFilter').value = '';
      document.getElementById('periodFilter').value = '';
      search(); // „Éï„Ç£„É´„Çø„ÇØ„É™„Ç¢Âæå„Å´ÂÜçÊ§úÁ¥¢
    }

    function onFilterChange(filterType, filterValue) {
      // Google Analytics: „Éï„Ç£„É´„Çø„Éº‰ΩøÁî®„Ç§„Éô„É≥„Éà„ÇíËøΩË∑°
      trackFilterUsage(filterType, filterValue);
      
      // „Éï„Ç£„É´„Çø„ÉºÂ§âÊõ¥Âæå„Å´Ëá™ÂãïÊ§úÁ¥¢
      search();
    }

    async function search() {
      const query = document.getElementById('searchInput').value;
      const subject = document.getElementById('subjectFilter').value;
      const grade = document.getElementById('gradeFilter').value;
      const period = document.getElementById('periodFilter').value;
      const resultsDiv = document.getElementById('results');
      
      // Google Analytics: Ê§úÁ¥¢„Ç§„Éô„É≥„Éà„ÇíËøΩË∑°
      trackSearch(query, {
        subject: subject,
        grade: grade,
        period: period
      });
      
      resultsDiv.innerHTML = '<div class="loading">Ê§úÁ¥¢‰∏≠</div>';
      
      // URL„Éë„É©„É°„Éº„Çø„ÇíÊßãÁØâ
      const params = new URLSearchParams();
      if (query) params.append('q', query);
      if (subject) params.append('subject', subject);
      if (grade) params.append('grade', grade);
      if (period) params.append('period', period);
      
      try {
        const response = await fetch('/search?' + params.toString());
        const data = await response.json();
        
        resultsDiv.innerHTML = '';
        
        if (data.length === 0) {
          resultsDiv.innerHTML = '<div class="error">Ê§úÁ¥¢ÁµêÊûú„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</div>';
          return;
        }
        
        for (const item of data) {
          const resultDiv = document.createElement('div');
          resultDiv.className = 'result-item';
          resultDiv.dataset.pageId = item.id;
          observer.observe(resultDiv);
          
          // „Çø„Ç§„Éà„É´
          const title = formatProperty(item.properties['ÂêçÂâç']) || '„Çø„Ç§„Éà„É´‰∏çÊòé';
          const titleDiv = document.createElement('div');
          titleDiv.className = 'result-title';
          titleDiv.textContent = title;
          
          // „É°„ÇøÊÉÖÂ†±
          const metaDiv = document.createElement('div');
          metaDiv.className = 'result-meta';
          
          // ÊïôÁßë
          const subjects = formatProperty(item.properties['ÊïôÁßë']);
          if (subjects) {
            const subjectSpan = document.createElement('span');
            subjectSpan.className = 'meta-item subject';
            subjectSpan.textContent = `ÊïôÁßë: ${subjects}`;
            metaDiv.appendChild(subjectSpan);
          }
          
          // Â≠¶Âπ¥
          const grade = formatProperty(item.properties['Â≠¶Âπ¥']);
          if (grade) {
            const gradeSpan = document.createElement('span');
            gradeSpan.className = 'meta-item grade';
            gradeSpan.textContent = `Â≠¶Âπ¥: ${grade}`;
            metaDiv.appendChild(gradeSpan);
          }
          
          // ÊôÇÊúü
          const period = formatProperty(item.properties['ÊôÇÊúü']);
          if (period) {
            const periodSpan = document.createElement('span');
            periodSpan.className = 'meta-item period';
            periodSpan.textContent = `ÊôÇÊúü: ${period}`;
            metaDiv.appendChild(periodSpan);
          }
          
          resultDiv.appendChild(titleDiv);
          resultDiv.appendChild(metaDiv);
          
          // „ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Ë©≥Á¥∞„ÇíË°®Á§∫„Åô„Çã„É™„É≥„ÇØ
          const showDetailsLink = document.createElement('a');
          showDetailsLink.textContent = '„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Éï„Ç°„Ç§„É´„ÇíË°®Á§∫';
          showDetailsLink.href = '#';
          showDetailsLink.style.cssText = `
            display: block;
            margin-top: 20px;
            padding: 16px 30px;
            background: linear-gradient(135deg, rgba(255, 145, 115, 0.85) 0%, rgba(255, 138, 101, 0.85) 100%);
            color: white;
            text-decoration: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(255, 145, 115, 0.2);
            position: relative;
            overflow: hidden;
          `;
          showDetailsLink.onmouseover = () => {
            showDetailsLink.style.background = 'linear-gradient(135deg, rgba(255, 134, 101, 0.9) 0%, rgba(255, 114, 86, 0.9) 100%)';
            showDetailsLink.style.transform = 'translateY(-3px)';
            showDetailsLink.style.boxShadow = '0 8px 25px rgba(255, 145, 115, 0.3)';
          };
          showDetailsLink.onmouseout = () => {
            showDetailsLink.style.background = 'linear-gradient(135deg, rgba(255, 145, 115, 0.85) 0%, rgba(255, 138, 101, 0.85) 100%)';
            showDetailsLink.style.transform = 'translateY(0)';
            showDetailsLink.style.boxShadow = '0 4px 16px rgba(255, 145, 115, 0.2)';
          };
          showDetailsLink.onclick = (e) => {
            e.preventDefault();
            // Google Analytics: „Éö„Éº„Ç∏Ë©≥Á¥∞Ë°®Á§∫„Ç§„Éô„É≥„Éà„ÇíËøΩË∑°
            trackPageDetailsView(item.properties.Name?.title?.[0]?.text?.content || 'Unknown Page');
            showPageDetails(item.id, resultDiv, showDetailsLink);
          };
          
          resultDiv.appendChild(showDetailsLink);
          resultsDiv.appendChild(resultDiv);
          
          // IntersectionObserver„ÅåË°®Á§∫„ÇíÊ§úÁü•„Åó„ÅüÈöõ„Å´„Éó„É™„É≠„Éº„Éâ„Åï„Çå„Åæ„Åô
        }
      } catch (error) {
        console.error('Ê§úÁ¥¢„Ç®„É©„Éº:', error);
        resultsDiv.innerHTML = '<div class="error">Ê§úÁ¥¢‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ</div>';
      }
    }

    // „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„Åß„Éö„Éº„Ç∏Ë©≥Á¥∞„Çí„Éó„É™„É≠„Éº„Éâ
    async function preloadPageDetails(pageId) {
      // Êó¢„Å´„Ç≠„É£„ÉÉ„Ç∑„É•„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
      if (pageDetailsCache.has(pageId)) {
        return;
      }
      
      try {
        const response = await fetch(`/page/${pageId}`);
        const data = await response.json();
        pageDetailsCache.set(pageId, data);
      } catch (error) {
        console.error('„Éö„Éº„Ç∏Ë©≥Á¥∞„ÅÆ„Éó„É™„É≠„Éº„Éâ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü:', error);
      }
    }

    // „Ç≠„É£„ÉÉ„Ç∑„É•„Åï„Çå„Åü„Éö„Éº„Ç∏Ë©≥Á¥∞„ÇíÂç≥Â∫ß„Å´Ë°®Á§∫
    async function showPageDetails(pageId, resultDiv, link) {
      // „É™„É≥„ÇØ„ÇíÁÑ°ÂäπÂåñ„Åó„Å¶„É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
      link.style.pointerEvents = 'none';
      link.style.opacity = '0.6';
      link.textContent = 'Ë™≠„ÅøËæº„Åø‰∏≠...';
      
      try {
        let data = pageDetailsCache.get(pageId);
        
        // „Ç≠„É£„ÉÉ„Ç∑„É•„Å´„Å™„ÅÑÂ†¥Âêà„ÅØÂç≥Â∫ß„Å´ÂèñÂæó
        if (!data) {
          const response = await fetch(`/page/${pageId}`);
          data = await response.json();
          pageDetailsCache.set(pageId, data);
        }
        
        // „Éï„Ç°„Ç§„É´„Çª„ÇØ„Ç∑„Éß„É≥„Çí‰ΩúÊàê
        let filesSection = resultDiv.querySelector('.files-section');
        if (!filesSection) {
          filesSection = document.createElement('div');
          filesSection.className = 'files-section';
          resultDiv.appendChild(filesSection);
        }
        
        filesSection.innerHTML = '';
        
        if (data.files && data.files.length > 0) {
          // „Éï„Ç°„Ç§„É´Ë°®Á§∫„Ç®„É™„Ç¢
          const filesTitle = document.createElement('h4');
          filesTitle.textContent = '„Éï„Ç°„Ç§„É´:';
          filesSection.appendChild(filesTitle);
          
          data.files.forEach(file => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file-item';
            
            const icon = document.createElement('span');
            icon.className = 'pdf-icon';
            icon.textContent = 'üìÑ';
            
            const link = document.createElement('a');
            link.className = 'file-link';
            link.href = file.url;
            link.textContent = file.name;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'file-actions';
            
            const viewBtn = document.createElement('button');
            viewBtn.className = 'file-btn';
            viewBtn.textContent = 'Ë°®Á§∫';
            viewBtn.onclick = () => {
              // Google Analytics: „Éï„Ç°„Ç§„É´Ë°®Á§∫„Ç§„Éô„É≥„Éà„ÇíËøΩË∑°
              trackFileAction('file_view', file.name, file.url);
              
              // iOS „ÅÆÂ†¥Âêà„ÅØÊñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åè
              const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
              if (isIOS) {
                window.open(file.url, '_blank', 'noopener,noreferrer');
              } else {
                showPDF(file.url, file.name, resultDiv);
              }
            };
            
            const openTabBtn = document.createElement('button');
            openTabBtn.className = 'file-btn open-tab';
            openTabBtn.textContent = 'Êñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åè';
            openTabBtn.onclick = () => {
              // Google Analytics: „Éï„Ç°„Ç§„É´Êñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åè„Ç§„Éô„É≥„Éà„ÇíËøΩË∑°
              trackFileAction('file_open_new_tab', file.name, file.url);
              window.open(file.url, '_blank', 'noopener,noreferrer');
            };
            
            actionsDiv.appendChild(viewBtn);
            
            // iOS „ÅÆÂ†¥Âêà„ÅØ„ÄåÊñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åè„Äç„Éú„Çø„É≥„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            if (!isIOS) {
              actionsDiv.appendChild(openTabBtn);
            }
            
            fileDiv.appendChild(icon);
            fileDiv.appendChild(link);
            fileDiv.appendChild(actionsDiv);
            filesSection.appendChild(fileDiv);
          });
        }
        
        // Â≠ê„Éö„Éº„Ç∏„ÅÆË°®Á§∫
        if (data.childPages && data.childPages.length > 0) {
          const childPagesTitle = document.createElement('h4');
          childPagesTitle.textContent = 'Â≠ê„Éö„Éº„Ç∏:';
          childPagesTitle.style.marginTop = '20px';
          filesSection.appendChild(childPagesTitle);
          
          data.childPages.forEach(childPage => {
            const childPageDiv = document.createElement('div');
            childPageDiv.className = 'child-page-item';
            // CSS„ÇØ„É©„Çπ„Åß„Çπ„Çø„Ç§„É™„É≥„Ç∞„ÇíË°å„ÅÜ„Åü„ÇÅ„ÄÅ„Ç§„É≥„É©„Ç§„É≥„Çπ„Çø„Ç§„É´„ÅØÊúÄÂ∞èÈôê„Å´
            
            const childPageTitle = document.createElement('h5');
            childPageTitle.textContent = childPage.title;
            childPageTitle.style.cssText = `
              margin: 0 0 10px 0;
              color: #2c3e50;
              font-size: 16px;
            `;
            childPageDiv.appendChild(childPageTitle);
            
            if (childPage.error) {
              const errorMsg = document.createElement('div');
              errorMsg.textContent = childPage.error;
              errorMsg.style.cssText = `
                color: #e74c3c;
                font-style: italic;
                font-size: 14px;
              `;
              childPageDiv.appendChild(errorMsg);
            } else {
              // Â≠ê„Éö„Éº„Ç∏„ÅÆË©≥Á¥∞„ÇíË°®Á§∫„Åô„Çã„Éú„Çø„É≥
              const showChildPageBtn = document.createElement('button');
              showChildPageBtn.textContent = 'Â≠ê„Éö„Éº„Ç∏„ÇíË°®Á§∫';
              showChildPageBtn.style.cssText = `
                padding: 12px 20px;
                background: linear-gradient(135deg, rgba(255, 145, 115, 0.9) 0%, rgba(255, 138, 101, 0.9) 100%);
                color: white;
                border: none;
                border-radius: 12px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 4px 12px rgba(255, 145, 115, 0.3);
                position: relative;
                overflow: hidden;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
              `;
              showChildPageBtn.onmouseover = () => {
                showChildPageBtn.style.background = 'linear-gradient(135deg, rgba(255, 134, 101, 1) 0%, rgba(255, 114, 86, 1) 100%)';
                showChildPageBtn.style.transform = 'translateY(-3px) scale(1.02)';
                showChildPageBtn.style.boxShadow = '0 8px 20px rgba(255, 145, 115, 0.4)';
              };
              showChildPageBtn.onmouseout = () => {
                showChildPageBtn.style.background = 'linear-gradient(135deg, rgba(255, 145, 115, 0.9) 0%, rgba(255, 138, 101, 0.9) 100%)';
                showChildPageBtn.style.transform = 'translateY(0) scale(1)';
                showChildPageBtn.style.boxShadow = '0 4px 12px rgba(255, 145, 115, 0.3)';
              };
              showChildPageBtn.onclick = () => {
                // Google Analytics: Â≠ê„Éö„Éº„Ç∏Ë°®Á§∫„Ç§„Éô„É≥„Éà„ÇíËøΩË∑°
                sendGAEvent('child_page_view', 'user_interaction', childPage.title);
                showChildPageDetails(childPage.id, childPageDiv, showChildPageBtn);
              };
              
              childPageDiv.appendChild(showChildPageBtn);
            }
            
            filesSection.appendChild(childPageDiv);
          });
        }
        
        // „Éö„Éº„Ç∏ÂÜÖÂÆπ„ÅÆË°®Á§∫
        if (data.content && data.content.length > 0) {
          // Ë¶™„Éö„Éº„Ç∏„ÅÆ„Åø„ÅÆÂÜÖÂÆπ„ÇíË°®Á§∫ÔºàÂ≠ê„Éö„Éº„Ç∏„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„ÅØÈô§Â§ñÔºâ
          // „Çµ„Éº„Éê„ÉºÂÅ¥„ÅßÊó¢„Å´Èô§Â§ñÊ∏à„Åø„Åß„Åô„Åå„ÄÅ„Éï„É≠„É≥„Éà„Ç®„É≥„ÉâÂÅ¥„Åß„ÇÇÁ¢∫ÂÆü„Å´„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
          const parentContentBlocks = data.content.filter(block => {
            // Â≠ê„Éö„Éº„Ç∏„Éñ„É≠„ÉÉ„ÇØ„ÇíÊòéÁ§∫ÁöÑ„Å´Èô§Â§ñ
            if (block.type === 'child_page') {
              console.log(`Excluding child_page block from parent content: ${block.child_page?.title || block.id}`);
              return false;
            }
            return true;
          });
          
          let markdownContent = '';
          parentContentBlocks.forEach(block => {
            if (block.type === 'paragraph' && block.paragraph.rich_text) {
              const text = block.paragraph.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += text + '\n\n';
              }
            } else if (block.type === 'heading_1' && block.heading_1.rich_text) {
              const text = block.heading_1.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '# ' + text + '\n\n';
              }
            } else if (block.type === 'heading_2' && block.heading_2.rich_text) {
              const text = block.heading_2.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '## ' + text + '\n\n';
              }
            } else if (block.type === 'heading_3' && block.heading_3.rich_text) {
              const text = block.heading_3.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '### ' + text + '\n\n';
              }
            } else if (block.type === 'bulleted_list_item' && block.bulleted_list_item.rich_text) {
              const text = block.bulleted_list_item.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '‚Ä¢ ' + text + '\n';
              }
            } else if (block.type === 'numbered_list_item' && block.numbered_list_item.rich_text) {
              const text = block.numbered_list_item.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '1. ' + text + '\n';
              }
            } else if (block.type === 'table') {
              markdownContent += '\n[TABLE_START]\n';
            } else if (block.type === 'table_row' && block.table_row && block.table_row.cells) {
              const cells = block.table_row.cells.map(cell => 
                cell.map(text => text.plain_text).join('').trim()
              );
              markdownContent += '| ' + cells.join(' | ') + ' |\n';
            }
          });
          
          // ÂÆüÈöõ„Å´„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„Åø„Éö„Éº„Ç∏ÂÜÖÂÆπ„Éñ„É≠„ÉÉ„ÇØ„ÇíË°®Á§∫
          if (markdownContent.trim()) {
            const contentDiv = document.createElement('div');
            contentDiv.className = 'page-content';
            contentDiv.style.marginTop = data.files && data.files.length > 0 || data.childPages && data.childPages.length > 0 ? '20px' : '0';
            
            const contentTitle = document.createElement('h4');
            contentTitle.textContent = '„É°„Ç§„É≥„Éö„Éº„Ç∏ÂÜÖÂÆπ:';
            contentTitle.style.cssText = `
              color: #2c3e50;
              margin-bottom: 10px;
              font-size: 16px;
              border-bottom: 2px solid rgba(44, 62, 80, 0.1);
              padding-bottom: 5px;
            `;
            contentDiv.appendChild(contentTitle);
            
            const contentText = document.createElement('div');
            contentText.className = 'page-text';
            contentText.innerHTML = parseMarkdownToHTML(markdownContent);
            contentDiv.appendChild(contentText);
            
            filesSection.appendChild(contentDiv);
          }
        }
        
        // „Éï„Ç°„Ç§„É´„ÇÇ„Éö„Éº„Ç∏ÂÜÖÂÆπ„ÇÇ„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
        // hasActualContentÈñ¢Êï∞„ÅØÊó¢„Å´Â≠ê„Éö„Éº„Ç∏„Éñ„É≠„ÉÉ„ÇØ„ÇíÈô§Â§ñ„Åó„Å¶Âà§ÂÆö„Åó„Å¶„ÅÑ„Çã
        if ((!data.files || data.files.length === 0) && 
            (!data.content || data.content.length === 0 || !hasActualContent(data.content))) {
          filesSection.innerHTML = '<div style="color: #2c3e50; font-style: italic; text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; border: 1px dashed rgba(44, 62, 80, 0.3);">„Éï„Ç°„Ç§„É´„Å®„Éö„Éº„Ç∏ÂÜÖÂÆπ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
        }
        
        // „É™„É≥„ÇØ„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
        link.style.display = 'none';
        
      } catch (error) {
        console.error('„Éö„Éº„Ç∏Ë©≥Á¥∞„ÅÆË°®Á§∫‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü:', error);
        link.style.pointerEvents = 'auto';
        link.style.opacity = '1';
        link.textContent = '„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Éï„Ç°„Ç§„É´„ÇíË°®Á§∫';
        
        let filesSection = resultDiv.querySelector('.files-section');
        if (!filesSection) {
          filesSection = document.createElement('div');
          filesSection.className = 'files-section';
          resultDiv.appendChild(filesSection);
        }
        filesSection.innerHTML = '<div style="color: #ff6b6b;">„Ç®„É©„Éº: Ë©≥Á¥∞„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü</div>';
      }
    }

    // Â≠ê„Éö„Éº„Ç∏„ÅÆË©≥Á¥∞„ÇíË°®Á§∫„Åô„ÇãÈñ¢Êï∞
    async function showChildPageDetails(childPageId, container, button) {
      // „Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ„Åó„Å¶„É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
      button.style.pointerEvents = 'none';
      button.style.opacity = '0.6';
      button.textContent = 'Ë™≠„ÅøËæº„Åø‰∏≠...';
      
      try {
        const response = await fetch(`/child-page/${childPageId}`);
        const data = await response.json();
        
        // Â≠ê„Éö„Éº„Ç∏Ë©≥Á¥∞„Çª„ÇØ„Ç∑„Éß„É≥„Çí‰ΩúÊàê
        let childDetailsSection = container.querySelector('.child-page-details');
        if (!childDetailsSection) {
          childDetailsSection = document.createElement('div');
          childDetailsSection.className = 'child-page-details';
          childDetailsSection.style.cssText = `
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
          `;
          container.appendChild(childDetailsSection);
        }
        
        childDetailsSection.innerHTML = '';
        
        // Â≠ê„Éö„Éº„Ç∏„ÅÆ„Éï„Ç°„Ç§„É´Ë°®Á§∫
        if (data.files && data.files.length > 0) {
          const filesTitle = document.createElement('h6');
          filesTitle.textContent = '„Éï„Ç°„Ç§„É´:';
          filesTitle.style.cssText = `
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 14px;
          `;
          childDetailsSection.appendChild(filesTitle);
          
          data.files.forEach(file => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'child-file-item';
            fileDiv.style.cssText = `
              display: flex;
              align-items: center;
              margin: 8px 0;
              padding: 8px;
              background: rgba(255, 255, 255, 0.1);
              border-radius: 6px;
              font-size: 14px;
            `;
            
            const icon = document.createElement('span');
            icon.textContent = 'üìÑ';
            icon.style.marginRight = '8px';
            
            const link = document.createElement('a');
            link.href = file.url;
            link.textContent = file.name;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.style.cssText = `
              color: #3498db;
              text-decoration: none;
              flex: 1;
            `;
            link.onmouseover = () => link.style.textDecoration = 'underline';
            link.onmouseout = () => link.style.textDecoration = 'none';
            
            const viewBtn = document.createElement('button');
            viewBtn.textContent = 'Ë°®Á§∫';
            viewBtn.style.cssText = `
              padding: 4px 8px;
              background: rgba(255, 145, 115, 0.7);
              color: white;
              border: none;
              border-radius: 4px;
              cursor: pointer;
              font-size: 12px;
              margin-left: 8px;
            `;
            viewBtn.onclick = () => {
              // Google Analytics: Â≠ê„Éö„Éº„Ç∏„Éï„Ç°„Ç§„É´Ë°®Á§∫„Ç§„Éô„É≥„Éà„ÇíËøΩË∑°
              trackFileAction('child_file_view', file.name, file.url);
              
              const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
              if (isIOS) {
                window.open(file.url, '_blank', 'noopener,noreferrer');
              } else {
                showPDF(file.url, file.name, childDetailsSection);
              }
            };
            
            fileDiv.appendChild(icon);
            fileDiv.appendChild(link);
            fileDiv.appendChild(viewBtn);
            childDetailsSection.appendChild(fileDiv);
          });
        }
        
        // Â≠ê„Éö„Éº„Ç∏„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑË°®Á§∫
        if (data.content && data.content.length > 0) {
          // Â≠ê„Éö„Éº„Ç∏ÂÜÖ„ÅßÊõ¥„Å´„Éç„Çπ„Éà„Åï„Çå„ÅüÂ≠ê„Éö„Éº„Ç∏„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÈô§Â§ñ
          const childContentBlocks = data.content.filter(block => {
            if (block.type === 'child_page') {
              console.log(`Excluding nested child_page block from child page content: ${block.child_page?.title || block.id}`);
              return false;
            }
            return true;
          });
          
          let markdownContent = '';
          childContentBlocks.forEach(block => {
            if (block.type === 'paragraph' && block.paragraph.rich_text) {
              const text = block.paragraph.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += text + '\n\n';
              }
            } else if (block.type === 'heading_1' && block.heading_1.rich_text) {
              const text = block.heading_1.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '# ' + text + '\n\n';
              }
            } else if (block.type === 'heading_2' && block.heading_2.rich_text) {
              const text = block.heading_2.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '## ' + text + '\n\n';
              }
            } else if (block.type === 'heading_3' && block.heading_3.rich_text) {
              const text = block.heading_3.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '### ' + text + '\n\n';
              }
            } else if (block.type === 'bulleted_list_item' && block.bulleted_list_item.rich_text) {
              const text = block.bulleted_list_item.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '‚Ä¢ ' + text + '\n';
              }
            } else if (block.type === 'numbered_list_item' && block.numbered_list_item.rich_text) {
              const text = block.numbered_list_item.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '1. ' + text + '\n';
              }
            } else if (block.type === 'table') {
              markdownContent += '\n[TABLE_START]\n';
            } else if (block.type === 'table_row' && block.table_row && block.table_row.cells) {
              const cells = block.table_row.cells.map(cell => 
                cell.map(text => text.plain_text).join('').trim()
              );
              markdownContent += '| ' + cells.join(' | ') + ' |\n';
            }
          });
          
          if (markdownContent.trim()) {
            const contentTitle = document.createElement('h6');
            contentTitle.textContent = '„Éö„Éº„Ç∏ÂÜÖÂÆπ:';
            contentTitle.style.cssText = `
              margin: 15px 0 10px 0;
              color: #2c3e50;
              font-size: 14px;
            `;
            childDetailsSection.appendChild(contentTitle);
            
            const contentText = document.createElement('div');
            contentText.className = 'child-page-text';
            contentText.style.cssText = `
              font-size: 14px;
              line-height: 1.6;
            `;
            contentText.innerHTML = parseMarkdownToHTML(markdownContent);
            childDetailsSection.appendChild(contentText);
          }
        }
        
        // „Éï„Ç°„Ç§„É´„ÇÇ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇÇ„Å™„ÅÑÂ†¥Âêà
        if ((!data.files || data.files.length === 0) && (!data.content || data.content.length === 0)) {
          childDetailsSection.innerHTML = '<div style="color: #7f8c8d; font-style: italic; text-align: center; padding: 10px; font-size: 14px;">„Åì„ÅÆÂ≠ê„Éö„Éº„Ç∏„Å´„ÅØ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
        }
        
        // „Éú„Çø„É≥„Çí„ÄåÈñâ„Åò„Çã„Äç„Å´Â§âÊõ¥
        button.style.pointerEvents = 'auto';
        button.style.opacity = '1';
        button.textContent = 'Â≠ê„Éö„Éº„Ç∏„ÇíÈñâ„Åò„Çã';
        button.onclick = () => {
          childDetailsSection.style.display = 'none';
          button.textContent = 'Â≠ê„Éö„Éº„Ç∏„ÇíË°®Á§∫';
          button.onclick = () => {
            childDetailsSection.style.display = 'block';
            button.textContent = 'Â≠ê„Éö„Éº„Ç∏„ÇíÈñâ„Åò„Çã';
            button.onclick = () => {
              childDetailsSection.style.display = 'none';
              button.textContent = 'Â≠ê„Éö„Éº„Ç∏„ÇíË°®Á§∫';
              button.onclick = () => {
                childDetailsSection.style.display = 'block';
                button.textContent = 'Â≠ê„Éö„Éº„Ç∏„ÇíÈñâ„Åò„Çã';
                button.onclick = arguments.callee.caller;
              };
            };
          };
        };
        
      } catch (error) {
        console.error('Â≠ê„Éö„Éº„Ç∏Ë©≥Á¥∞„ÅÆË°®Á§∫‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü:', error);
        button.style.pointerEvents = 'auto';
        button.style.opacity = '1';
        button.textContent = 'Â≠ê„Éö„Éº„Ç∏„ÇíË°®Á§∫';
        
        let childDetailsSection = container.querySelector('.child-page-details');
        if (!childDetailsSection) {
          childDetailsSection = document.createElement('div');
          childDetailsSection.className = 'child-page-details';
          container.appendChild(childDetailsSection);
        }
        childDetailsSection.innerHTML = '<div style="color: #e74c3c; font-size: 14px;">„Ç®„É©„Éº: Â≠ê„Éö„Éº„Ç∏„ÅÆË©≥Á¥∞„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü</div>';
      }
    }

    // PDFË°®Á§∫Èñ¢Êï∞
    function showPDF(url, name, container) {
      // Êó¢Â≠ò„ÅÆPDF„Éì„É•„Éº„Ç¢„Éº„Åå„ÅÇ„Çå„Å∞ÂâäÈô§
      const existingViewer = container.querySelector('.pdf-viewer, .ios-pdf-viewer');
      if (existingViewer) {
        existingViewer.remove();
      }
      
      // „É¶„Éº„Ç∂„Éº„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÅÆÊ§úÂá∫
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      
      if (isIOS || isSafari) {
        // iOS/SafariÁî®„ÅÆÁâπÂà•„Å™Âá¶ÁêÜ
        const iosViewer = document.createElement('div');
        iosViewer.className = 'ios-pdf-viewer';
        iosViewer.innerHTML = `
          <div class="ios-pdf-message" style="
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
          ">
            <p style="margin-bottom: 15px; color: #2c3e50; font-weight: 500;">
              üì± ${name}
            </p>
            <p style="margin-bottom: 15px; color: #2c3e50; font-size: 14px;">
              iOS„Éá„Éê„Ç§„Çπ„Åß„ÅØPDF„ÇíÊñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åç„Åæ„Åô
            </p>
            <button onclick="window.open('${url}', '_blank', 'noopener,noreferrer')" style="
              padding: 12px 20px;
              background: linear-gradient(135deg, rgba(255, 145, 115, 0.85) 0%, rgba(255, 138, 101, 0.85) 100%);
              color: white;
              border: none;
              border-radius: 10px;
              cursor: pointer;
              font-size: 16px;
              font-weight: 600;
              border: 2px solid rgba(255, 255, 255, 0.3);
              backdrop-filter: blur(10px);
              transition: all 0.3s ease;
            ">
              PDF„ÇíÈñã„Åè
            </button>
          </div>
        `;
        container.appendChild(iosViewer);
      } else {
        // „Åù„ÅÆ‰ªñ„ÅÆ„Éñ„É©„Ç¶„Ç∂Áî®
        const iframe = document.createElement('iframe');
        iframe.className = 'pdf-viewer';
        iframe.src = url;
        iframe.title = name;
        iframe.style.cssText = `
          width: 100%;
          height: 400px;
          border: 1px solid rgba(255, 255, 255, 0.3);
          border-radius: 15px;
          margin-top: 15px;
          backdrop-filter: blur(10px);
          animation: fadeInUp 0.6s ease-out;
        `;
        
        // ÁîªÈù¢ÂπÖ„Å´Âøú„Åò„Å¶È´ò„Åï„ÇíË™øÊï¥
        if (window.innerWidth >= 768) {
          iframe.style.height = '70vh';
          iframe.style.minHeight = '500px';
          iframe.style.maxWidth = '100vw';
        } else if (window.innerWidth < 480) {
          iframe.style.height = '60vh';
          iframe.style.minHeight = '';
        }
        
        container.appendChild(iframe);
      }
    }

    // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢Ë°®Á§∫‰∏≠„ÅÆ„Çπ„ÇØ„É≠„Éº„É´Âà∂Âæ°
    function disableScroll() {
      document.body.style.overflow = 'hidden';
      document.documentElement.style.overflow = 'hidden';
    }
    
    function enableScroll() {
      document.body.style.overflow = '';
      document.documentElement.style.overflow = '';
    }

    // Ê≠£ËëâÊõ≤Á∑ö„É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
    function startRoseLoadingAnimation() {
      const svg = document.getElementById('roseSVG');
      const path = document.getElementById('rosePath');
      const gradient = document.getElementById('roseGradient');
      const shadowPath = document.getElementById('roseShadowPath');
      const highlightPath = document.getElementById('roseHighlightPath');
      
      // SVG„ÅÆviewBox„ÇíÁîªÈù¢„Çµ„Ç§„Ç∫„Å´Âøú„Åò„Å¶ÂãïÁöÑ„Å´Ë™øÊï¥
      function adjustSVGViewBox() {
        const containerWidth = window.innerWidth;
        const containerHeight = window.innerHeight;
        const size = Math.min(containerWidth, containerHeight);
        
        // viewBox„ÅÆ„Çµ„Ç§„Ç∫„ÇíÂ§ßÂπÖ„Å´Êã°Â§ß„Åó„Å¶Ë¶ãÂàá„Çå„ÇíÈò≤Ê≠¢
        let viewBoxSize = 500; // „Éá„Éï„Ç©„É´„Éà„ÇíÂ§ßÂπÖ„Å´Â¢óÂä†Ôºà400‚Üí500Ôºâ
        
        if (size <= 480) {
          viewBoxSize = 450; // „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥Ôºà350‚Üí450Ôºâ
        } else if (size <= 1024) {
          viewBoxSize = 475; // „Çø„Éñ„É¨„ÉÉ„ÉàÔºà375‚Üí475Ôºâ
        } else {
          viewBoxSize = 500; // „Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÔºà400‚Üí500Ôºâ
        }
        
        svg.setAttribute('viewBox', `-${viewBoxSize} -${viewBoxSize} ${viewBoxSize * 2} ${viewBoxSize * 2}`);
      }
      
      // ÂàùÊúüË™øÊï¥
      adjustSVGViewBox();
      
      // „Ç¶„Ç£„É≥„Éâ„Ç¶„É™„Çµ„Ç§„Ç∫ÊôÇ„ÅÆË™øÊï¥
      window.addEventListener('resize', adjustSVGViewBox);
      
      // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Â§âÊï∞
      let startTime = Date.now();
      const minDuration = 3500; // ÊúÄÂ∞è4.5ÁßíÈñì„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ôºà6‚Üí4.5Áßí„Å´Áü≠Á∏ÆÔºâ
      const maxDuration = 5500; // ÊúÄÂ§ß6ÁßíÈñì„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ôºà8‚Üí6Áßí„Å´Áü≠Á∏ÆÔºâ
      let animationId;
      
      // Ê≠£ËëâÊõ≤Á∑ö„ÅÆ„Éë„É©„É°„Éº„Çø: r = a * cos(n * Œ∏)
      const n = 3; // Ëëâ„ÅÆÊï∞Ôºà3ÊûöËëâ„ÅßÂÑ™ÈõÖ„Å´Ôºâ
      const a = 1; // Âü∫Ê∫ñÂçäÂæÑ
      const baseRadius = 150; // SVGÂ∫ßÊ®ôÁ≥ª„Åß„ÅÆÂü∫Ê∫ñÂçäÂæÑÔºà120‚Üí150„Å´Êã°Â§ßÔºâ
      
      // „Ç§„Éº„Ç∏„É≥„Ç∞Èñ¢Êï∞Ôºà„Çà„Çä„ÇÜ„Å£„Åè„Çä„Å®„Åó„ÅüÂ§âÂåñÔºâ
      function easeInOutQuart(t) {
        return t < 0.5 ? 8 * t * t * t * t : 1 - Math.pow(-2 * t + 2, 4) / 2;
      }
      
      // „Çà„ÇäÁ©è„ÇÑ„Åã„Å™„Ç§„Éº„Ç∏„É≥„Ç∞Èñ¢Êï∞ÔºàÊúÄÂàù„Å®ÊúÄÂæå„Çí„ÇÜ„Å£„Åè„ÇäÔºâ
      function gentleEasing(t) {
        // „Ç´„Çπ„Çø„É†„Ç§„Éº„Ç∏„É≥„Ç∞ÔºöÊúÄÂàù„Å®ÊúÄÂæå„ÇíÈùûÂ∏∏„Å´„ÇÜ„Å£„Åè„Çä„ÄÅ‰∏≠Èñì„ÇíÊªë„Çâ„Åã„Å´
        return t * t * (3 - 2 * t); // „Çπ„É†„Éº„Ç∫„Çπ„ÉÜ„ÉÉ„ÉóÈñ¢Êï∞
      }
      
      // Ê≠£ËëâÊõ≤Á∑ö„ÅÆÂ∫ßÊ®ô„ÇíË®àÁÆó„Åô„ÇãÈñ¢Êï∞
      function getRoseCoordinates(theta, amplitude = 1, frequency = 1, offset = 0) {
        const r = amplitude * Math.cos(frequency * theta) * baseRadius;
        const x = r * Math.cos(theta + offset);
        const y = r * Math.sin(theta + offset);
        return { x, y };
      }
      
      // SVG„Éë„ÇπÊñáÂ≠óÂàó„ÇíÁîüÊàê„Åô„ÇãÈñ¢Êï∞ÔºàÂ∑¶Á´Ø„Åã„ÇâÊµÅ„Çå„Çã„Çà„ÅÜ„Å´Ôºâ
      function generateRosePath(progress, amplitude, frequency, offset = 0, startAngle = -Math.PI, endAngle = Math.PI) {
        let pathData = '';
        const totalRange = endAngle - startAngle;
        const currentRange = totalRange * progress;
        const steps = Math.max(300, Math.floor(currentRange * 150)); // „Çπ„ÉÜ„ÉÉ„ÉóÊï∞Â¢óÂä†„ÅßÊªë„Çâ„Åã„Å´
        
        if (steps <= 0) return '';
        
        for (let i = 0; i <= steps; i++) {
          const theta = startAngle + (currentRange * i) / steps;
          const { x, y } = getRoseCoordinates(theta, amplitude, frequency, offset);
          
          if (i === 0) {
            pathData += `M ${x} ${y}`;
          } else {
            pathData += ` L ${x} ${y}`;
          }
        }
        
        return pathData;
      }
      
      function animate() {
        const currentTime = Date.now();
        const elapsed = currentTime - startTime;
        
        // ÂãïÁöÑ„Å™Á∂ôÁ∂öÊôÇÈñìË®àÁÆó
        const loadComplete = document.readyState === 'complete';
        const duration = loadComplete ? minDuration : maxDuration;
        const rawProgress = Math.min(elapsed / duration, 1);
        const progress = gentleEasing(rawProgress); // „Çà„ÇäÁ©è„ÇÑ„Åã„Å™„Ç§„Éº„Ç∏„É≥„Ç∞ÈÅ©Áî®
        
        if (progress <= 0.2) {
          // 0-20%: Â∑¶Á´Ø„Åã„ÇâÊ≠£ËëâÊõ≤Á∑ö„ÅåÈÄü„ÇÑ„Åã„Å´ÊµÅ„ÇåÂßã„ÇÅ„ÇãÔºà25%‚Üí20%„Å´Áü≠Á∏ÆÔºâ
          const phaseProgress = progress / 0.2;
          const smoothPhase = gentleEasing(phaseProgress); // „Éï„Çß„Éº„Ç∫ÂÜÖ„Åß„ÇÇ„Ç§„Éº„Ç∏„É≥„Ç∞ÈÅ©Áî®
          const amplitude = 0.3 + (0.4 * smoothPhase); // „Çà„ÇäÊó©„ÅÑÊåØÂπÖÂ§âÂåñ
          const frequency = n; // Âü∫Êú¨Âë®Ê≥¢Êï∞
          
          const mainPath = generateRosePath(smoothPhase, amplitude, frequency);
          path.setAttribute('d', mainPath);
          path.setAttribute('stroke-width', '1.5');
          path.setAttribute('opacity', '0.7');
          
          // „Ç∑„É£„Éâ„Ç¶„Å®„Éè„Ç§„É©„Ç§„Éà„ÇÇÂêåÊúü
          shadowPath.setAttribute('d', mainPath);
          highlightPath.setAttribute('d', mainPath);
          
        } else if (progress <= 0.45) {
          // 20-45%: ÊåØÂπÖ„ÅåÊÄ•ÈÄü„Å´Â§ß„Åç„Åè„ÄÅÂë®Êúü„ÅåÁü≠„ÅèÂ§âÂåñÔºà„Éî„Éº„ÇØ„ÇíÊó©„ÅèÔºâ
          const phaseProgress = (progress - 0.2) / 0.25;
          const smoothPhase = gentleEasing(phaseProgress);
          const amplitude = 0.7 + (1.4 * smoothPhase); // „Çà„ÇäÊÄ•ÈÄü„Å™Â¢óÂä†„Åß„Éî„Éº„ÇØ„ÇíÊó©„Åè
          const frequency = n + (2.2 * smoothPhase); // Âë®ÊúüÂ§âÂåñ„ÇÇÊÄ•ÈÄü
          
          // Âè≥ÂÅ¥„Åã„Çâ„Ç´„Éº„Éñ„ÅåÈáç„Å™„ÇäÂêà„ÅÑÂßã„ÇÅ„Çã
          const leftPath = generateRosePath(1, amplitude, frequency, 0, -Math.PI, 0);
          const rightPath = generateRosePath(smoothPhase, amplitude, frequency, Math.PI, 0, Math.PI);
          
          const combinedPath = leftPath + ' ' + rightPath;
          path.setAttribute('d', combinedPath);
          path.setAttribute('stroke-width', '2.5');
          path.setAttribute('opacity', '0.85');
          
          // „Ç∑„É£„Éâ„Ç¶„Å®„Éè„Ç§„É©„Ç§„Éà„ÇÇÂêåÊúü
          shadowPath.setAttribute('d', combinedPath);
          highlightPath.setAttribute('d', combinedPath);
          
        } else if (progress <= 0.65) {
          // 45-65%: ÁîªÈù¢ÂÖ®‰Ωì„ÅåÊ≠£ËëâÊõ≤Á∑ö„ÅÆÂØÜ„Å™„É©„Ç§„É≥„ÅßÂüã„ÇÅÂ∞Ω„Åè„Åï„Çå„ÇãÔºà„Éî„Éº„ÇØÁ∂≠ÊåÅÔºâ
          const phaseProgress = (progress - 0.45) / 0.2;
          const smoothPhase = gentleEasing(phaseProgress);
          const amplitude = 2.1 + (0.3 * smoothPhase); // „Éî„Éº„ÇØÊåØÂπÖ„ÇíÊó©„ÅèÂà∞ÈÅî„ÉªÁ∂≠ÊåÅ
          const frequency = n + 2.2 + (0.3 * smoothPhase); // È´òÂë®Ê≥¢Êï∞„ÇíÁ∂≠ÊåÅ
          
          // Ë§áÊï∞„ÅÆÈáç„Å™„Çä„ÅßÂØÜÂ∫¶„Çí‰∏ä„Åí„Çã
          let combinedPath = '';
          for (let layer = 0; layer < 3; layer++) {
            const layerOffset = (layer * Math.PI * 2) / 3;
            const layerPath = generateRosePath(1, amplitude, frequency, layerOffset);
            combinedPath += layerPath + ' ';
          }
          
          path.setAttribute('d', combinedPath);
          path.setAttribute('stroke-width', '2.5');
          path.setAttribute('opacity', '0.95');
          
          // „Ç∑„É£„Éâ„Ç¶„Å®„Éè„Ç§„É©„Ç§„Éà„ÇÇÂêåÊúü
          shadowPath.setAttribute('d', combinedPath);
          highlightPath.setAttribute('d', combinedPath);
          
        } else {
          // 65-100%: ÊåØÂπÖÊ∏õÂ∞ë„ÄÅÂë®ÊúüÂª∂Èï∑„ÄÅÂè≥Á´Ø„Åã„Çâ„ÇÜ„Å£„Åè„Çä„Å®Ê∂àÂ§±
          const phaseProgress = (progress - 0.65) / 0.35;
          const smoothPhase = gentleEasing(phaseProgress); // „ÇÜ„Å£„Åè„Çä„Å®„Åó„Åü„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
          const amplitude = 2.4 * (1 - smoothPhase * 0.75); // „Çà„ÇäÁ©è„ÇÑ„Åã„Å™ÊåØÂπÖÊ∏õÂ∞ë
          const frequency = (n + 2.5) * (1 - smoothPhase * 0.3); // Âë®ÊúüÂª∂Èï∑„Çí„ÇÜ„Å£„Åè„Çä
          
          // Âè≥Á´Ø„Åã„ÇâÊ∂à„Åà„Å¶„ÅÑ„ÅèÂäπÊûúÔºà„ÇÜ„Å£„Åè„Çä„Å®„Åó„Åü„Éï„Çß„Éº„ÉâÔºâ
          const visibleRange = 1 - (smoothPhase * 0.60);
          const fadePath = generateRosePath(visibleRange, amplitude, frequency, 0, -Math.PI, Math.PI * visibleRange);
          
          path.setAttribute('d', fadePath);
          path.setAttribute('stroke-width', `${2.5 * (1 - smoothPhase * 0.6)}`);
          path.setAttribute('opacity', `${0.95 * (1 - smoothPhase * 0.7)}`);
          
          // „Ç∑„É£„Éâ„Ç¶„Å®„Éè„Ç§„É©„Ç§„Éà„ÇÇÂêåÊúüÔºà„ÇÜ„Å£„Åè„Çä„Å®„Åó„Åü„Éï„Çß„Éº„ÉâÔºâ
          shadowPath.setAttribute('d', fadePath);
          highlightPath.setAttribute('d', fadePath);
          shadowPath.setAttribute('opacity', `${0.3 * (1 - smoothPhase * 0.6)}`);
          highlightPath.setAttribute('opacity', `${0.6 * (1 - smoothPhase * 0.6)}`);
        }
        
        if (progress < 1) {
          animationId = requestAnimationFrame(animate);
        } else {
          // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆå‰∫Ü - ÂÖ®Ë¶ÅÁ¥†„Çí„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
          path.setAttribute('opacity', '0');
          shadowPath.setAttribute('opacity', '0');
          highlightPath.setAttribute('opacity', '0');
          
          // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢„ÇíÂÆåÂÖ®„Å´„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
          setTimeout(() => {
            fadeOutLoadingScreen();
          }, 100);
        }
      }
      
      // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã
      animate();
    }
    
    // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢„ÅÆ„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
    function fadeOutLoadingScreen() {
      const loadingScreen = document.getElementById('loadingScreen');
      const mainContent = document.getElementById('mainContent');
      
      // 300ms ease-out „Éï„Çß„Éº„Éâ
      loadingScreen.style.transition = 'opacity 0.3s ease-out, visibility 0.3s ease-out';
      loadingScreen.classList.add('hidden');
      
      // „Çπ„ÇØ„É≠„Éº„É´„ÇíÊúâÂäπ„Å´„Åô„Çã
      enableScroll();
      
      // „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí„Éï„Çß„Éº„Éâ„Ç§„É≥
      setTimeout(() => {
        mainContent.classList.add('visible');
      }, 50); // 150ms ‚Üí 50ms
    }

    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂàùÊúüÂåñ
    window.addEventListener('DOMContentLoaded', () => {
      // „Çπ„ÇØ„É≠„Éº„É´„ÇíÁÑ°Âäπ„Å´„Åô„Çã
      disableScroll();

      const isSmallScreen = window.matchMedia('(max-width: 480px)').matches;

      // Ê≠£ËëâÊõ≤Á∑ö„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Åæ„Åü„ÅØ„Çπ„Éî„Éä„Éº„ÇíÈñãÂßã
      if (isSmallScreen) {
        const spinner = document.getElementById('spinnerContainer');
        if (spinner) {
          spinner.style.display = 'flex';
        }
      } else {
        startRoseLoadingAnimation();
      }
      
      // ÂàùÊúüÂåñÂÆå‰∫ÜÂæå„ÅÆ„É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢Âà∂Âæ°
      initializeFilters().then(() => {
        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅÆÊúÄÂ∞èË°®Á§∫ÊôÇÈñì„ÇíÁ¢∫‰øùÔºàÊôÇÈñìÁü≠Á∏ÆÔºâ
        const loadingStartTime = Date.now();
        const minDisplayTime = 700; // 1.5Áßí ‚Üí 700„Éü„É™Áßí„Å´Áü≠Á∏Æ
        
        setTimeout(() => {
          const elapsedTime = Date.now() - loadingStartTime;
          const remainingTime = Math.max(0, minDisplayTime - elapsedTime);

          setTimeout(() => {
            if (isSmallScreen) {
              fadeOutLoadingScreen();
            }
            // Â§ßÁîªÈù¢„Åß„ÅØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅÆÁµÇ‰∫Ü„ÇíÂæÖ„Å§
          }, remainingTime);
        }, 100);
      }).catch((error) => {
        console.error('ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
        // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å¶„ÇÇ„É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢„ÅØÈÅ©Âàá„Å™„Çø„Ç§„Éü„É≥„Ç∞„ÅßÈùûË°®Á§∫„Å´„Åô„Çã
        setTimeout(() => {
          fadeOutLoadingScreen();
        }, 2500); // „Ç®„É©„ÉºÊôÇ„ÅÆË°®Á§∫ÊôÇÈñì„ÇÇÁü≠Á∏ÆÔºà3Áßí‚Üí2.5ÁßíÔºâ
      });
    });

    // Enter„Ç≠„Éº„ÅßÊ§úÁ¥¢
    document.getElementById('searchInput')?.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        // Google Analytics: Enter„Ç≠„Éº„Å´„Çà„ÇãÊ§úÁ¥¢„Ç§„Éô„É≥„Éà„ÇíËøΩË∑°
        sendGAEvent('search_enter_key', 'user_interaction', 'search_input');
        search();
      }
    });

    // initializeFiltersÈñ¢Êï∞„ÇíPromise„ÇíËøî„Åô„Çà„ÅÜ„Å´‰øÆÊ≠£
    async function initializeFilters() {
      try {
        const response = await fetch('/filters');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´‰øùÂ≠ò
        filterOptions = data;
        
        // „Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„Çπ„Å´„Ç™„Éó„Ç∑„Éß„É≥„ÇíËøΩÂä†
        populateFilterOptions('subjectFilter', data.subjects);
        populateFilterOptions('gradeFilter', data.grades);
        populateFilterOptions('periodFilter', data.periods);
        
        console.log('„Éï„Ç£„É´„Çø„ÅÆÂàùÊúüÂåñ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü');
      } catch (error) {
        console.error('„Éï„Ç£„É´„Çø„ÅÆÂàùÊúüÂåñ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü:', error);
        throw error;
      }
    }
  </script>
  </div> <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑÁµÇ‰∫Ü -->
</body>
</html>
