<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="color-scheme" content="light dark" />
  <title>éå»å•æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ </title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="style.css">
  
  <!-- Google Analytics (GA4) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-13VGFN8ZFX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-13VGFN8ZFX', {
      page_title: 'Kakomon Search System',
      page_location: window.location.href
    });

    // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡é–¢æ•°
    function sendGAEvent(action, category, label, value) {
      gtag('event', action, {
        event_category: category,
        event_label: label,
        value: value
      });
    }

    // æ¤œç´¢ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
    function trackSearch(searchQuery, filters) {
      gtag('event', 'search', {
        search_term: searchQuery,
        event_category: 'engagement',
        event_label: 'kakomon_search',
        custom_parameters: {
          subject_filter: filters.subject || '',
          grade_filter: filters.grade || '',
          period_filter: filters.period || ''
        }
      });
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«é–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
    function trackFileAction(action, fileName, fileUrl) {
      gtag('event', action, {
        event_category: 'file_interaction',
        event_label: fileName,
        file_url: fileUrl
      });
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ“ä½œã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
    function trackFilterUsage(filterType, filterValue) {
      gtag('event', 'filter_usage', {
        event_category: 'user_interaction',
        event_label: filterType,
        filter_value: filterValue
      });
    }

    // ãƒšãƒ¼ã‚¸è©³ç´°è¡¨ç¤ºã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
    function trackPageDetailsView(pageTitle) {
      gtag('event', 'view_page_details', {
        event_category: 'content_interaction',
        event_label: pageTitle
      });
    }
  </script>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
  <div id="loadingScreen" class="loading-screen">
    <div class="rose-loading-container">
      <svg id="roseSVG" viewBox="-400 -400 800 800" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <!-- é’åŸºèª¿ãƒ¡ã‚¤ãƒ³ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ -->
          <linearGradient id="roseGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color: var(--accent-color); stop-opacity:1" />
            <stop offset="50%" style="stop-color: var(--accent-color-end); stop-opacity:1" />
            <stop offset="100%" style="stop-color: var(--accent-color-end); stop-opacity:1" />
          </linearGradient>
          
          <!-- 3Dã‚·ãƒ£ãƒ‰ã‚¦ç”¨ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ -->
          <linearGradient id="shadowGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color: var(--accent-color); stop-opacity:0.4" />
            <stop offset="100%" style="stop-color: var(--accent-color-end); stop-opacity:0.2" />
          </linearGradient>
          
          <!-- ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ -->
          <linearGradient id="highlightGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color: var(--accent-color); stop-opacity:0.8" />
            <stop offset="100%" style="stop-color: var(--accent-color-end); stop-opacity:0.4" />
          </linearGradient>
          
          <!-- ã‚½ãƒ•ãƒˆãƒ–ãƒ©ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
          <filter id="softBlur" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur in="SourceGraphic" stdDeviation="1"/>
            <feColorMatrix type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 1.2 0"/>
          </filter>
          
          <!-- ã‚°ãƒ­ãƒ¼åŠ¹æœ -->
          <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
            <feMerge> 
              <feMergeNode in="coloredBlur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>
        
        <!-- ã‚·ãƒ£ãƒ‰ã‚¦ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆå¥¥è¡Œãæ„Ÿã®ãŸã‚ï¼‰ -->
        <path id="roseShadowPath" d="" stroke="url(#shadowGradient)" stroke-width="3" fill="none" 
              stroke-linecap="round" stroke-linejoin="round" opacity="0.3" 
              transform="translate(2, 2)" style="filter: url(#softBlur)"/>
        
        <!-- ãƒ¡ã‚¤ãƒ³ãƒ‘ã‚¹ -->
        <path id="rosePath" d="" stroke="url(#roseGradient)" stroke-width="2.5" fill="none" 
              stroke-linecap="round" stroke-linejoin="round" style="filter: url(#glow)"/>
        
        <!-- ãƒã‚¤ãƒ©ã‚¤ãƒˆãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆå…‰ã®åå°„æ„Ÿï¼‰ -->
        <path id="roseHighlightPath" d="" stroke="url(#highlightGradient)" stroke-width="1" fill="none" 
              stroke-linecap="round" stroke-linejoin="round" opacity="0.6" 
              transform="translate(-1, -1)" style="filter: url(#softBlur)"/>
      </svg>
    </div>
    <div class="spinner-container" id="spinnerContainer">
      <div class="spinner"></div>
      <div class="spinner-text">ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«ãªã‚‹ã‚ˆã†ã«ãªã£ãŸ</div>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div id="mainContent" class="main-content">
    <div class="container">
    <h1>éå»å•æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ </h1>
    <div class="search-box">
      <label for="searchInput" class="visually-hidden">æ¤œç´¢</label>
      <input type="text" id="searchInput" placeholder="ç§‘ç›®åã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
      <button onclick="search()">æ¤œç´¢</button>
    </div>
    
    <!-- ãƒ•ã‚£ãƒ«ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <button id="filterToggle" class="filter-toggle" aria-expanded="false" aria-controls="filtersContainer">Filters</button>
    <div id="filterOverlay" class="filter-overlay"></div>
    <div class="mobile-filter">
    <div class="filters" id="filtersContainer">
      <div class="filter-row">
        <div class="filter-group">
          <label class="filter-label">æ•™ç§‘</label>
          <select id="subjectFilter" onchange="onFilterChange('subject', this.value)">
            <option value="">ã™ã¹ã¦</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">å­¦å¹´</label>
          <select id="gradeFilter" onchange="onFilterChange('grade', this.value)">
            <option value="">ã™ã¹ã¦</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">æ™‚æœŸ</label>
          <select id="periodFilter" onchange="onFilterChange('period', this.value)">
            <option value="">ã™ã¹ã¦</option>
          </select>
        </div>
      </div>
      <button class="clear-filters" onclick="clearFilters()">ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
    </div>
    <button id="closeFilter">Ã—</button>
    </div>
    
    <div id="results" role="region" aria-live="polite"></div>
  </div>

  <script>
    // ãƒ•ã‚£ãƒ«ã‚¿ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°
    let filterOptions = {
      subjects: new Set(),
      grades: new Set(),
      periods: new Set()
    };

    // ãƒšãƒ¼ã‚¸è©³ç´°ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    const pageDetailsCache = new Map();

    // ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ç”¨ã®ã‚­ãƒ¥ãƒ¼ã¨åŒæ™‚å®Ÿè¡Œæ•°åˆ¶é™
    const preloadQueue = [];
    let activePreloads = 0;
    const MAX_CONCURRENT_PRELOADS = 3;

    function schedulePreload(pageId) {
      if (pageDetailsCache.has(pageId) || preloadQueue.includes(pageId)) {
        return;
      }
      preloadQueue.push(pageId);
      runNextPreload();
    }

    function runNextPreload() {
      if (activePreloads >= MAX_CONCURRENT_PRELOADS || preloadQueue.length === 0) {
        return;
      }
      const id = preloadQueue.shift();
      activePreloads++;
      preloadPageDetails(id).finally(() => {
        activePreloads--;
        runNextPreload();
      });
    }

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const id = entry.target.dataset.pageId;
          if (id) schedulePreload(id);
          observer.unobserve(entry.target);
        }
      });
    });

    // ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†ã—ã¦è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function formatProperty(property) {
      if (property.type === 'title') {
        return property.title.map(t => t.plain_text).join('');
      } else if (property.type === 'multi_select') {
        return property.multi_select.map(s => s.name).join(', ');
      } else if (property.type === 'select' && property.select) {
        return property.select.name;
      } else if (property.type === 'date' && property.date) {
        return property.date.start;
      } else if (property.type === 'number' && property.number !== null) {
        return property.number.toString();
      } else if (property.type === 'rich_text') {
        return property.rich_text.map(t => t.plain_text).join('');
      }
      return '';
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHTML(str) {
      return str ? str.replace(/[&<>"']/g, c => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[c])) : '';
    }

    // å®Ÿéš›ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function hasActualContent(content) {
      if (!content || content.length === 0) return false;
      
      // å­ãƒšãƒ¼ã‚¸ãƒ–ãƒ­ãƒƒã‚¯ã‚’é™¤å¤–ã—ã¦ã‹ã‚‰ãƒã‚§ãƒƒã‚¯
      const nonChildPageContent = content.filter(block => block.type !== 'child_page');
      
      for (const block of nonChildPageContent) {
        if (block.type === 'paragraph' && block.paragraph.rich_text) {
          const text = block.paragraph.rich_text.map(text => text.plain_text).join('').trim();
          if (text) return true;
        } else if (block.type === 'heading_1' && block.heading_1.rich_text) {
          const text = block.heading_1.rich_text.map(text => text.plain_text).join('').trim();
          if (text) return true;
        } else if (block.type === 'heading_2' && block.heading_2.rich_text) {
          const text = block.heading_2.rich_text.map(text => text.plain_text).join('').trim();
          if (text) return true;
        } else if (block.type === 'heading_3' && block.heading_3.rich_text) {
          const text = block.heading_3.rich_text.map(text => text.plain_text).join('').trim();
          if (text) return true;
        } else if (block.type === 'bulleted_list_item' && block.bulleted_list_item.rich_text) {
          const text = block.bulleted_list_item.rich_text.map(text => text.plain_text).join('').trim();
          if (text) return true;
        } else if (block.type === 'numbered_list_item' && block.numbered_list_item.rich_text) {
          const text = block.numbered_list_item.rich_text.map(text => text.plain_text).join('').trim();
          if (text) return true;
        } else if (block.type === 'table_row' && block.table_row && block.table_row.cells) {
          const hasContent = block.table_row.cells.some(cell => 
            cell.some(text => text.plain_text.trim())
          );
          if (hasContent) return true;
        }
      }
      return false;
    }

    // Markdownãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æã—ã¦HTMLã«å¤‰æ›ã™ã‚‹é–¢æ•°
    function parseMarkdownToHTML(markdown) {
      if (!markdown) return '';
      
      // è¡Œã”ã¨ã«åˆ†å‰²
      const lines = markdown.split('\n');
      let html = '';
      let inList = false;
      let listType = null;
      let inTable = false;
      let isFirstTableRow = true;
      let tableHeaders = [];
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const trimmedLine = line.trim();
        
        if (!trimmedLine) {
          continue;
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«é–‹å§‹ãƒãƒ¼ã‚«ãƒ¼ã®å‡¦ç†
        if (trimmedLine === '[TABLE_START]') {
          if (inList) {
            html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
            inList = false;
            listType = null;
          }
          inTable = true;
          isFirstTableRow = true;
          html += '<div class="table-container"><table>\n';
          continue;
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã®æ¤œå‡ºï¼ˆ|ã§åŒºåˆ‡ã‚‰ã‚ŒãŸè¡Œï¼‰
        if (trimmedLine.includes('|') && trimmedLine.split('|').length > 2) {
          const cells = trimmedLine.split('|').map(cell => cell.trim()).filter(cell => cell);
          
          if (!inTable) {
            // ãƒ†ãƒ¼ãƒ–ãƒ«é–‹å§‹
            if (inList) {
              html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
              inList = false;
              listType = null;
            }
            html += '<div class="table-container"><table>\n';
            inTable = true;
            isFirstTableRow = true;
          }
          
          if (isFirstTableRow) {
            tableHeaders = cells;
            html += '<thead>\n<tr>\n';
            cells.forEach(cell => {
              html += `<th>${cell}</th>\n`;
            });
            html += '</tr>\n</thead>\n<tbody>\n';
            isFirstTableRow = false;
          } else {
            html += '<tr>\n';
            cells.forEach((cell, idx) => {
              const header = tableHeaders[idx] || '';
              html += `<td data-label="${header}">${cell}</td>\n`;
            });
            html += '</tr>\n';
          }
          continue;
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ä»¥å¤–ã®å‡¦ç†ã®å ´åˆã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’çµ‚äº†
        if (inTable) {
          html += '</tbody></table></div>\n';
          inTable = false;
          isFirstTableRow = true;
          tableHeaders = [];
        }
        
        // è¦‹å‡ºã—
        if (trimmedLine.startsWith('### ')) {
          if (inList) {
            html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
            inList = false;
            listType = null;
          }
          html += `<h3>${trimmedLine.substring(4)}</h3>\n`;
        } else if (trimmedLine.startsWith('## ')) {
          if (inList) {
            html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
            inList = false;
            listType = null;
          }
          html += `<h2>${trimmedLine.substring(3)}</h2>\n`;
        } else if (trimmedLine.startsWith('# ')) {
          if (inList) {
            html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
            inList = false;
            listType = null;
          }
          html += `<h1>${trimmedLine.substring(2)}</h1>\n`;
        }
        // ç®‡æ¡æ›¸ã
        else if (trimmedLine.startsWith('â€¢ ') || trimmedLine.startsWith('- ')) {
          if (!inList || listType !== 'ul') {
            if (inList && listType === 'ol') {
              html += '</ol>\n';
            }
            html += '<ul>\n';
            inList = true;
            listType = 'ul';
          }
          html += `<li>${trimmedLine.substring(2)}</li>\n`;
        }
        // ç•ªå·ä»˜ããƒªã‚¹ãƒˆ
        else if (/^\d+\.\s/.test(trimmedLine)) {
          if (!inList || listType !== 'ol') {
            if (inList && listType === 'ul') {
              html += '</ul>\n';
            }
            html += '<ol>\n';
            inList = true;
            listType = 'ol';
          }
          html += `<li>${trimmedLine.replace(/^\d+\.\s/, '')}</li>\n`;
        }
        // é€šå¸¸ã®æ®µè½
        else {
          if (inList) {
            html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
            inList = false;
            listType = null;
          }
          html += `<p>${trimmedLine}</p>\n`;
        }
      }
      
      // æœ€å¾Œã«ãƒªã‚¹ãƒˆã‚„ãƒ†ãƒ¼ãƒ–ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯é–‰ã˜ã‚‹
      if (inList) {
        html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
      }
      if (inTable) {
        html += '</tbody></table></div>\n';
      }
      
      return html;
    }

    function populateFilterOptions(selectId, options) {
      const select = document.getElementById(selectId);
      // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆ"ã™ã¹ã¦"ä»¥å¤–ï¼‰ã‚’ã‚¯ãƒªã‚¢
      while (select.children.length > 1) {
        select.removeChild(select.lastChild);
      }
      
      // æ–°ã—ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
      options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        select.appendChild(optionElement);
      });
    }

    function clearFilters() {
      // Google Analytics: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½è·¡
      sendGAEvent('clear_filters', 'user_interaction', 'filter_controls');

      document.getElementById('subjectFilter').value = '';
      document.getElementById('gradeFilter').value = '';
      document.getElementById('periodFilter').value = '';
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®å€¤ã‚‚ã‚¯ãƒªã‚¢
      localStorage.removeItem('subjectFilter');
      localStorage.removeItem('gradeFilter');
      localStorage.removeItem('periodFilter');
      localStorage.removeItem('searchInput');
      search(); // ãƒ•ã‚£ãƒ«ã‚¿ã‚¯ãƒªã‚¢å¾Œã«å†æ¤œç´¢
    }

    function onFilterChange(filterType, filterValue) {
      // Google Analytics: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä½¿ç”¨ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½è·¡
      trackFilterUsage(filterType, filterValue);

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å€¤ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
      localStorage.setItem(`${filterType}Filter`, filterValue);

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´å¾Œã«è‡ªå‹•æ¤œç´¢
      search();

      // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
      if (window.matchMedia('(max-width: 600px)').matches) {
        document.querySelector('.mobile-filter')?.classList.remove('open');
        document.getElementById('filterOverlay')?.classList.remove('open');
        document.getElementById('filterToggle')?.setAttribute('aria-expanded', 'false');
      }
    }

    async function search() {
      const query = document.getElementById('searchInput').value;
      const subject = document.getElementById('subjectFilter').value;
      const grade = document.getElementById('gradeFilter').value;
      const period = document.getElementById('periodFilter').value;
      const resultsDiv = document.getElementById('results');
      
      // Google Analytics: æ¤œç´¢ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½è·¡
      trackSearch(query, {
        subject: subject,
        grade: grade,
        period: period
      });
      
      resultsDiv.innerHTML = '<div class="loading">æ¤œç´¢ä¸­</div>';
      
      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
      const params = new URLSearchParams();
      if (query) params.append('q', query);
      if (subject) params.append('subject', subject);
      if (grade) params.append('grade', grade);
      if (period) params.append('period', period);
      
      try {
        const response = await fetch('/search?' + params.toString());
        const data = await response.json();

        resultsDiv.innerHTML = '';

        if (data.length === 0) {
          resultsDiv.innerHTML = '<div class="error">æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
          return;
        }

        let html = '';
        for (const item of data) {
          const title = formatProperty(item.properties['åå‰']) || 'ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜';
          const subjects = formatProperty(item.properties['æ•™ç§‘']);
          const grd = formatProperty(item.properties['å­¦å¹´']);
          const prd = formatProperty(item.properties['æ™‚æœŸ']);

          html += `<div class="result-item" data-page-id="${item.id}" data-page-title="${escapeHTML(title)}">`;
          html += `<div class="result-title">${escapeHTML(title)}</div>`;
          html += '<div class="result-meta">';
          if (subjects) html += `<span class="meta-item subject">æ•™ç§‘: ${escapeHTML(subjects)}</span>`;
          if (grd) html += `<span class="meta-item grade">å­¦å¹´: ${escapeHTML(grd)}</span>`;
          if (prd) html += `<span class="meta-item period">æ™‚æœŸ: ${escapeHTML(prd)}</span>`;
          html += '</div>';
          html += '<a href="#" class="show-details-btn">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤º</a>';
          html += '</div>';
        }

        resultsDiv.innerHTML = html;

        resultsDiv.querySelectorAll('.result-item').forEach(resultDiv => {
          const id = resultDiv.dataset.pageId;
          observer.observe(resultDiv);

          const showDetailsLink = resultDiv.querySelector('.show-details-btn');
          showDetailsLink.style.cssText = `
            display: block;
            margin-top: 20px;
            padding: 16px 30px;
            color: white;
            text-decoration: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
          `;

          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
          if (isDarkMode) {
            showDetailsLink.style.background = 'linear-gradient(135deg, rgba(90, 159, 212, 0.8) 0%, rgba(123, 179, 224, 0.8) 100%)';
            showDetailsLink.style.boxShadow = '0 4px 16px rgba(90, 159, 212, 0.2)';
          } else {
            showDetailsLink.style.background = 'linear-gradient(135deg, rgba(255, 145, 115, 0.85) 0%, rgba(255, 138, 101, 0.85) 100%)';
            showDetailsLink.style.boxShadow = '0 4px 16px rgba(255, 145, 115, 0.2)';
          }

          showDetailsLink.onmouseover = () => {
            if (isDarkMode) {
              showDetailsLink.style.background = 'linear-gradient(135deg, rgba(123, 179, 224, 0.9) 0%, rgba(160, 196, 232, 0.9) 100%)';
              showDetailsLink.style.boxShadow = '0 8px 25px rgba(90, 159, 212, 0.3)';
            } else {
              showDetailsLink.style.background = 'linear-gradient(135deg, rgba(255, 134, 101, 0.9) 0%, rgba(255, 114, 86, 0.9) 100%)';
              showDetailsLink.style.boxShadow = '0 8px 25px rgba(255, 145, 115, 0.3)';
            }
            showDetailsLink.style.transform = 'translateY(-3px)';
          };
          showDetailsLink.onmouseout = () => {
            if (isDarkMode) {
              showDetailsLink.style.background = 'linear-gradient(135deg, rgba(90, 159, 212, 0.8) 0%, rgba(123, 179, 224, 0.8) 100%)';
              showDetailsLink.style.boxShadow = '0 4px 16px rgba(90, 159, 212, 0.2)';
            } else {
              showDetailsLink.style.background = 'linear-gradient(135deg, rgba(255, 145, 115, 0.85) 0%, rgba(255, 138, 101, 0.85) 100%)';
              showDetailsLink.style.boxShadow = '0 4px 16px rgba(255, 145, 115, 0.2)';
            }
            showDetailsLink.style.transform = 'translateY(0)';
          };
          showDetailsLink.onclick = (e) => {
            e.preventDefault();
            trackPageDetailsView(resultDiv.dataset.pageTitle || 'Unknown Page');
            showPageDetails(id, resultDiv, showDetailsLink);
          };
        });
      } catch (error) {
        console.error('æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
        resultsDiv.innerHTML = '<div class="error">æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</div>';
      }
    }

    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ãƒšãƒ¼ã‚¸è©³ç´°ã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
    async function preloadPageDetails(pageId) {
      // æ—¢ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
      if (pageDetailsCache.has(pageId)) {
        return;
      }
      
      try {
        const response = await fetch(`/page/${pageId}`);
        const data = await response.json();
        pageDetailsCache.set(pageId, data);
      } catch (error) {
        console.error('ãƒšãƒ¼ã‚¸è©³ç´°ã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
      }
    }

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãƒšãƒ¼ã‚¸è©³ç´°ã‚’å³åº§ã«è¡¨ç¤º
    async function showPageDetails(pageId, resultDiv, link) {
      // ãƒªãƒ³ã‚¯ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      link.style.pointerEvents = 'none';
      link.style.opacity = '0.6';
      link.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
      
      try {
        let data = pageDetailsCache.get(pageId);
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãªã„å ´åˆã¯å³åº§ã«å–å¾—
        if (!data) {
          const response = await fetch(`/page/${pageId}`);
          data = await response.json();
          pageDetailsCache.set(pageId, data);
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
        let filesSection = resultDiv.querySelector('.files-section');
        if (!filesSection) {
          filesSection = document.createElement('div');
          filesSection.className = 'files-section';
          resultDiv.appendChild(filesSection);
        }
        
        filesSection.innerHTML = '';
        
        if (data.files && data.files.length > 0) {
          // ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºã‚¨ãƒªã‚¢
          const filesTitle = document.createElement('h4');
          filesTitle.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«:';
          filesSection.appendChild(filesTitle);
          
          data.files.forEach(file => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file-item';
            
            const icon = document.createElement('span');
            icon.className = 'pdf-icon';
            icon.textContent = 'ğŸ“„';
            
            const link = document.createElement('a');
            link.className = 'file-link';
            link.href = file.url;
            link.textContent = file.name;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'file-actions';
            
            const viewBtn = document.createElement('button');
            viewBtn.className = 'file-btn';
            viewBtn.textContent = 'è¡¨ç¤º';
            viewBtn.onclick = () => {
              // Google Analytics: ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½è·¡
              trackFileAction('file_view', file.name, file.url);
              
              // iOS ã®å ´åˆã¯æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
              const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
              if (isIOS) {
                window.open(file.url, '_blank', 'noopener,noreferrer');
              } else {
                showPDF(file.url, file.name, resultDiv);
              }
            };
            
            const openTabBtn = document.createElement('button');
            openTabBtn.className = 'file-btn open-tab';
            openTabBtn.textContent = 'æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã';
            openTabBtn.onclick = () => {
              // Google Analytics: ãƒ•ã‚¡ã‚¤ãƒ«æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½è·¡
              trackFileAction('file_open_new_tab', file.name, file.url);
              window.open(file.url, '_blank', 'noopener,noreferrer');
            };
            
            actionsDiv.appendChild(viewBtn);
            
            // iOS ã®å ´åˆã¯ã€Œæ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã€ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            if (!isIOS) {
              actionsDiv.appendChild(openTabBtn);
            }
            
            fileDiv.appendChild(icon);
            fileDiv.appendChild(link);
            fileDiv.appendChild(actionsDiv);
            filesSection.appendChild(fileDiv);
          });
        }
        
        // å­ãƒšãƒ¼ã‚¸ã®è¡¨ç¤º
        if (data.childPages && data.childPages.length > 0) {
          const childPagesTitle = document.createElement('h4');
          childPagesTitle.textContent = 'å­ãƒšãƒ¼ã‚¸:';
          childPagesTitle.style.marginTop = '20px';
          filesSection.appendChild(childPagesTitle);
          
          data.childPages.forEach(childPage => {
            const childPageDiv = document.createElement('div');
            childPageDiv.className = 'child-page-item';
            // CSSã‚¯ãƒ©ã‚¹ã§ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã‚’è¡Œã†ãŸã‚ã€ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã¯æœ€å°é™ã«
            
            const childPageTitle = document.createElement('h5');
            childPageTitle.textContent = childPage.title;
            childPageTitle.style.cssText = `
              margin: 0 0 10px 0;
              color: var(--text-color);
              font-size: 16px;
            `;
            childPageDiv.appendChild(childPageTitle);
            
            if (childPage.error) {
              const errorMsg = document.createElement('div');
              errorMsg.textContent = childPage.error;
              errorMsg.style.cssText = `
                color: #e74c3c;
                font-style: italic;
                font-size: 14px;
              `;
              childPageDiv.appendChild(errorMsg);
            } else {
              // å­ãƒšãƒ¼ã‚¸ã®è©³ç´°ã‚’è¡¨ç¤ºã™ã‚‹ãƒœã‚¿ãƒ³
              const showChildPageBtn = document.createElement('button');
              showChildPageBtn.textContent = 'å­ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º';
              
              // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
              const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
              
              showChildPageBtn.style.cssText = `
                padding: 12px 20px;
                color: white;
                border: none;
                border-radius: 12px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
              `;
              
              if (isDarkMode) {
                showChildPageBtn.style.background = 'linear-gradient(135deg, rgba(90, 159, 212, 0.8) 0%, rgba(123, 179, 224, 0.8) 100%)';
                showChildPageBtn.style.boxShadow = '0 4px 12px rgba(90, 159, 212, 0.3)';
              } else {
                showChildPageBtn.style.background = 'linear-gradient(135deg, rgba(255, 145, 115, 0.9) 0%, rgba(255, 138, 101, 0.9) 100%)';
                showChildPageBtn.style.boxShadow = '0 4px 12px rgba(255, 145, 115, 0.3)';
              }
              
              showChildPageBtn.onmouseover = () => {
                if (isDarkMode) {
                  showChildPageBtn.style.background = 'linear-gradient(135deg, rgba(123, 179, 224, 0.9) 0%, rgba(160, 196, 232, 0.9) 100%)';
                  showChildPageBtn.style.boxShadow = '0 8px 20px rgba(90, 159, 212, 0.4)';
                } else {
                  showChildPageBtn.style.background = 'linear-gradient(135deg, rgba(255, 134, 101, 1) 0%, rgba(255, 114, 86, 1) 100%)';
                  showChildPageBtn.style.boxShadow = '0 8px 20px rgba(255, 145, 115, 0.4)';
                }
                showChildPageBtn.style.transform = 'translateY(-3px) scale(1.02)';
              };
              showChildPageBtn.onmouseout = () => {
                if (isDarkMode) {
                  showChildPageBtn.style.background = 'linear-gradient(135deg, rgba(90, 159, 212, 0.8) 0%, rgba(123, 179, 224, 0.8) 100%)';
                  showChildPageBtn.style.boxShadow = '0 4px 12px rgba(90, 159, 212, 0.3)';
                } else {
                  showChildPageBtn.style.background = 'linear-gradient(135deg, rgba(255, 145, 115, 0.9) 0%, rgba(255, 138, 101, 0.9) 100%)';
                  showChildPageBtn.style.boxShadow = '0 4px 12px rgba(255, 145, 115, 0.3)';
                }
                showChildPageBtn.style.transform = 'translateY(0) scale(1)';
              };
              showChildPageBtn.onclick = () => {
                // Google Analytics: å­ãƒšãƒ¼ã‚¸è¡¨ç¤ºã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½è·¡
                sendGAEvent('child_page_view', 'user_interaction', childPage.title);
                showChildPageDetails(childPage.id, childPageDiv, showChildPageBtn);
              };
              
              childPageDiv.appendChild(showChildPageBtn);
            }
            
            filesSection.appendChild(childPageDiv);
          });
        }
        
        // ãƒšãƒ¼ã‚¸å†…å®¹ã®è¡¨ç¤º
        if (data.content && data.content.length > 0) {
          // è¦ªãƒšãƒ¼ã‚¸ã®ã¿ã®å†…å®¹ã‚’è¡¨ç¤ºï¼ˆå­ãƒšãƒ¼ã‚¸ã®ãƒ–ãƒ­ãƒƒã‚¯ã¯é™¤å¤–ï¼‰
          // ã‚µãƒ¼ãƒãƒ¼å´ã§æ—¢ã«é™¤å¤–æ¸ˆã¿ã§ã™ãŒã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã§ã‚‚ç¢ºå®Ÿã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
          const parentContentBlocks = data.content.filter(block => {
            // å­ãƒšãƒ¼ã‚¸ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ˜ç¤ºçš„ã«é™¤å¤–
            if (block.type === 'child_page') {
              console.log(`Excluding child_page block from parent content: ${block.child_page?.title || block.id}`);
              return false;
            }
            return true;
          });
          
          let markdownContent = '';
          parentContentBlocks.forEach(block => {
            if (block.type === 'paragraph' && block.paragraph.rich_text) {
              const text = block.paragraph.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += text + '\n\n';
              }
            } else if (block.type === 'heading_1' && block.heading_1.rich_text) {
              const text = block.heading_1.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '# ' + text + '\n\n';
              }
            } else if (block.type === 'heading_2' && block.heading_2.rich_text) {
              const text = block.heading_2.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '## ' + text + '\n\n';
              }
            } else if (block.type === 'heading_3' && block.heading_3.rich_text) {
              const text = block.heading_3.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '### ' + text + '\n\n';
              }
            } else if (block.type === 'bulleted_list_item' && block.bulleted_list_item.rich_text) {
              const text = block.bulleted_list_item.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += 'â€¢ ' + text + '\n';
              }
            } else if (block.type === 'numbered_list_item' && block.numbered_list_item.rich_text) {
              const text = block.numbered_list_item.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '1. ' + text + '\n';
              }
            } else if (block.type === 'table') {
              markdownContent += '\n[TABLE_START]\n';
            } else if (block.type === 'table_row' && block.table_row && block.table_row.cells) {
              const cells = block.table_row.cells.map(cell => 
                cell.map(text => text.plain_text).join('').trim()
              );
              markdownContent += '| ' + cells.join(' | ') + ' |\n';
            }
          });
          
          // å®Ÿéš›ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã‚ã‚‹å ´åˆã®ã¿ãƒšãƒ¼ã‚¸å†…å®¹ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¡¨ç¤º
          if (markdownContent.trim()) {
            const contentDiv = document.createElement('div');
            contentDiv.className = 'page-content';
            contentDiv.style.marginTop = data.files && data.files.length > 0 || data.childPages && data.childPages.length > 0 ? '20px' : '0';
            
            const contentTitle = document.createElement('h4');
            contentTitle.textContent = 'ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸å†…å®¹:';
            contentTitle.style.cssText = `
              color: var(--text-color);
              margin-bottom: 10px;
              font-size: 16px;
              border-bottom: 2px solid rgba(44, 62, 80, 0.1);
              padding-bottom: 5px;
            `;
            contentDiv.appendChild(contentTitle);
            
            const contentText = document.createElement('div');
            contentText.className = 'page-text';
            contentText.innerHTML = parseMarkdownToHTML(markdownContent);
            contentDiv.appendChild(contentText);
            
            filesSection.appendChild(contentDiv);
          }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ãƒšãƒ¼ã‚¸å†…å®¹ã‚‚ãªã„å ´åˆã®ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        // hasActualContenté–¢æ•°ã¯æ—¢ã«å­ãƒšãƒ¼ã‚¸ãƒ–ãƒ­ãƒƒã‚¯ã‚’é™¤å¤–ã—ã¦åˆ¤å®šã—ã¦ã„ã‚‹
        if ((!data.files || data.files.length === 0) && 
            (!data.content || data.content.length === 0 || !hasActualContent(data.content))) {
          filesSection.innerHTML = '<div style="color: var(--text-color); font-style: italic; text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; border: 1px dashed rgba(44, 62, 80, 0.3);">ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒšãƒ¼ã‚¸å†…å®¹ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        }
        
        // ãƒªãƒ³ã‚¯ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        link.style.display = 'none';
        
      } catch (error) {
        console.error('ãƒšãƒ¼ã‚¸è©³ç´°ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
        link.style.pointerEvents = 'auto';
        link.style.opacity = '1';
        link.textContent = 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤º';
        
        let filesSection = resultDiv.querySelector('.files-section');
        if (!filesSection) {
          filesSection = document.createElement('div');
          filesSection.className = 'files-section';
          resultDiv.appendChild(filesSection);
        }
        filesSection.innerHTML = '<div style="color: #ff6b6b;">ã‚¨ãƒ©ãƒ¼: è©³ç´°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>';
      }
    }

    // å­ãƒšãƒ¼ã‚¸ã®è©³ç´°ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    async function showChildPageDetails(childPageId, container, button) {
      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      button.style.pointerEvents = 'none';
      button.style.opacity = '0.6';
      button.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
      
      try {
        const response = await fetch(`/child-page/${childPageId}`);
        const data = await response.json();
        
        // å­ãƒšãƒ¼ã‚¸è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
        let childDetailsSection = container.querySelector('.child-page-details');
        if (!childDetailsSection) {
          childDetailsSection = document.createElement('div');
          childDetailsSection.className = 'child-page-details';
          childDetailsSection.style.cssText = `
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
          `;
          container.appendChild(childDetailsSection);
        }
        
        childDetailsSection.innerHTML = '';
        
        // å­ãƒšãƒ¼ã‚¸ã®ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤º
        if (data.files && data.files.length > 0) {
          const filesTitle = document.createElement('h6');
          filesTitle.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«:';
          filesTitle.style.cssText = `
            margin: 0 0 10px 0;
            color: var(--text-color);
            font-size: 14px;
          `;
          childDetailsSection.appendChild(filesTitle);
          
          data.files.forEach(file => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'child-file-item';
            fileDiv.style.cssText = `
              display: flex;
              align-items: center;
              margin: 8px 0;
              padding: 8px;
              background: rgba(255, 255, 255, 0.1);
              border-radius: 6px;
              font-size: 14px;
            `;
            
            const icon = document.createElement('span');
            icon.textContent = 'ğŸ“„';
            icon.style.marginRight = '8px';
            
            const link = document.createElement('a');
            link.href = file.url;
            link.textContent = file.name;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.style.cssText = `
              color: var(--accent-color);
              text-decoration: none;
              flex: 1;
            `;
            link.onmouseover = () => link.style.textDecoration = 'underline';
            link.onmouseout = () => link.style.textDecoration = 'none';
            
            const viewBtn = document.createElement('button');
            viewBtn.textContent = 'è¡¨ç¤º';
            viewBtn.style.cssText = `
              padding: 4px 8px;
              background: rgba(255, 145, 115, 0.7);
              color: white;
              border: none;
              border-radius: 4px;
              cursor: pointer;
              font-size: 12px;
              margin-left: 8px;
            `;
            viewBtn.onclick = () => {
              // Google Analytics: å­ãƒšãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½è·¡
              trackFileAction('child_file_view', file.name, file.url);
              
              const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
              if (isIOS) {
                window.open(file.url, '_blank', 'noopener,noreferrer');
              } else {
                showPDF(file.url, file.name, childDetailsSection);
              }
            };
            
            fileDiv.appendChild(icon);
            fileDiv.appendChild(link);
            fileDiv.appendChild(viewBtn);
            childDetailsSection.appendChild(fileDiv);
          });
        }
        
        // å­ãƒšãƒ¼ã‚¸ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤º
        if (data.content && data.content.length > 0) {
          // å­ãƒšãƒ¼ã‚¸å†…ã§æ›´ã«ãƒã‚¹ãƒˆã•ã‚ŒãŸå­ãƒšãƒ¼ã‚¸ãŒã‚ã‚‹å ´åˆã¯é™¤å¤–
          const childContentBlocks = data.content.filter(block => {
            if (block.type === 'child_page') {
              console.log(`Excluding nested child_page block from child page content: ${block.child_page?.title || block.id}`);
              return false;
            }
            return true;
          });
          
          let markdownContent = '';
          childContentBlocks.forEach(block => {
            if (block.type === 'paragraph' && block.paragraph.rich_text) {
              const text = block.paragraph.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += text + '\n\n';
              }
            } else if (block.type === 'heading_1' && block.heading_1.rich_text) {
              const text = block.heading_1.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '# ' + text + '\n\n';
              }
            } else if (block.type === 'heading_2' && block.heading_2.rich_text) {
              const text = block.heading_2.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '## ' + text + '\n\n';
              }
            } else if (block.type === 'heading_3' && block.heading_3.rich_text) {
              const text = block.heading_3.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '### ' + text + '\n\n';
              }
            } else if (block.type === 'bulleted_list_item' && block.bulleted_list_item.rich_text) {
              const text = block.bulleted_list_item.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += 'â€¢ ' + text + '\n';
              }
            } else if (block.type === 'numbered_list_item' && block.numbered_list_item.rich_text) {
              const text = block.numbered_list_item.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '1. ' + text + '\n';
              }
            } else if (block.type === 'table') {
              markdownContent += '\n[TABLE_START]\n';
            } else if (block.type === 'table_row' && block.table_row && block.table_row.cells) {
              const cells = block.table_row.cells.map(cell => 
                cell.map(text => text.plain_text).join('').trim()
              );
              markdownContent += '| ' + cells.join(' | ') + ' |\n';
            }
          });
          
          if (markdownContent.trim()) {
            const contentTitle = document.createElement('h6');
            contentTitle.textContent = 'ãƒšãƒ¼ã‚¸å†…å®¹:';
            contentTitle.style.cssText = `
              margin: 15px 0 10px 0;
              color: var(--text-color);
              font-size: 14px;
            `;
            childDetailsSection.appendChild(contentTitle);
            
            const contentText = document.createElement('div');
            contentText.className = 'child-page-text';
            contentText.style.cssText = `
              font-size: 14px;
              line-height: 1.6;
            `;
            contentText.innerHTML = parseMarkdownToHTML(markdownContent);
            childDetailsSection.appendChild(contentText);
          }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚‚ãªã„å ´åˆ
        if ((!data.files || data.files.length === 0) && (!data.content || data.content.length === 0)) {
          childDetailsSection.innerHTML = '<div style="color: #7f8c8d; font-style: italic; text-align: center; padding: 10px; font-size: 14px;">ã“ã®å­ãƒšãƒ¼ã‚¸ã«ã¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        }
        
        // ãƒœã‚¿ãƒ³ã‚’ã€Œé–‰ã˜ã‚‹ã€ã«å¤‰æ›´
        button.style.pointerEvents = 'auto';
        button.style.opacity = '1';
        button.textContent = 'å­ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹';
        button.onclick = () => {
          childDetailsSection.style.display = 'none';
          button.textContent = 'å­ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º';
          button.onclick = () => {
            childDetailsSection.style.display = 'block';
            button.textContent = 'å­ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹';
            button.onclick = () => {
              childDetailsSection.style.display = 'none';
              button.textContent = 'å­ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º';
              button.onclick = () => {
                childDetailsSection.style.display = 'block';
                button.textContent = 'å­ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹';
                button.onclick = arguments.callee.caller;
              };
            };
          };
        };
        
      } catch (error) {
        console.error('å­ãƒšãƒ¼ã‚¸è©³ç´°ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
        button.style.pointerEvents = 'auto';
        button.style.opacity = '1';
        button.textContent = 'å­ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º';
        
        let childDetailsSection = container.querySelector('.child-page-details');
        if (!childDetailsSection) {
          childDetailsSection = document.createElement('div');
          childDetailsSection.className = 'child-page-details';
          container.appendChild(childDetailsSection);
        }
        childDetailsSection.innerHTML = '<div style="color: #e74c3c; font-size: 14px;">ã‚¨ãƒ©ãƒ¼: å­ãƒšãƒ¼ã‚¸ã®è©³ç´°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>';
      }
    }

    // PDFè¡¨ç¤ºé–¢æ•°
    function showPDF(url, name, container) {
      // æ—¢å­˜ã®PDFãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ãŒã‚ã‚Œã°å‰Šé™¤
      const existingViewer = container.querySelector('.pdf-viewer, .ios-pdf-viewer');
      if (existingViewer) {
        existingViewer.remove();
      }
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ¤œå‡º
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      
      if (isIOS || isSafari) {
        // iOS/Safariç”¨ã®ç‰¹åˆ¥ãªå‡¦ç†
        const iosViewer = document.createElement('div');
        iosViewer.className = 'ios-pdf-viewer';
        iosViewer.innerHTML = `
          <div class="ios-pdf-message" style="
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
          ">
            <p style="margin-bottom: 15px; color: var(--text-color); font-weight: 500;">
              ğŸ“± ${name}
            </p>
            <p style="margin-bottom: 15px; color: var(--text-color); font-size: 14px;">
              iOSãƒ‡ãƒã‚¤ã‚¹ã§ã¯PDFã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã™
            </p>
            <button onclick="window.open('${url}', '_blank', 'noopener,noreferrer')" style="
              padding: 12px 20px;
              background: linear-gradient(135deg, rgba(255, 145, 115, 0.85) 0%, rgba(255, 138, 101, 0.85) 100%);
              color: white;
              border: none;
              border-radius: 10px;
              cursor: pointer;
              font-size: 16px;
              font-weight: 600;
              border: 2px solid rgba(255, 255, 255, 0.3);
              backdrop-filter: blur(10px);
              transition: all 0.3s ease;
            ">
              PDFã‚’é–‹ã
            </button>
          </div>
        `;
        container.appendChild(iosViewer);
      } else {
        // ãã®ä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶ç”¨
        const iframe = document.createElement('iframe');
        iframe.className = 'pdf-viewer';
        iframe.src = url;
        iframe.title = name;
        iframe.style.cssText = `
          width: 100%;
          height: 400px;
          border: 1px solid rgba(255, 255, 255, 0.3);
          border-radius: 15px;
          margin-top: 15px;
          backdrop-filter: blur(10px);
          animation: fadeInUp 0.6s ease-out;
        `;
        
        // ç”»é¢å¹…ã«å¿œã˜ã¦é«˜ã•ã‚’èª¿æ•´
        if (window.innerWidth >= 768) {
          iframe.style.height = '70vh';
          iframe.style.minHeight = '500px';
          iframe.style.maxWidth = '100vw';
        } else if (window.innerWidth < 480) {
          iframe.style.height = '60vh';
          iframe.style.minHeight = '';
        }
        
        container.appendChild(iframe);
      }
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢è¡¨ç¤ºä¸­ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡
    function disableScroll() {
      document.body.style.overflow = 'hidden';
      document.documentElement.style.overflow = 'hidden';
    }
    
    function enableScroll() {
      document.body.style.overflow = '';
      document.documentElement.style.overflow = '';
    }

    // æ­£è‘‰æ›²ç·šãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    function startRoseLoadingAnimation() {
      const svg = document.getElementById('roseSVG');
      const path = document.getElementById('rosePath');
      const gradient = document.getElementById('roseGradient');
      const shadowPath = document.getElementById('roseShadowPath');
      const highlightPath = document.getElementById('roseHighlightPath');

      function applyThemeToGradients() {
        const styles = getComputedStyle(document.documentElement);
        const accentStart = styles.getPropertyValue('--accent-color').trim();
        const accentEnd = styles.getPropertyValue('--accent-color-end').trim();

        const roseStops = gradient.querySelectorAll('stop');
        if (roseStops.length >= 3) {
          roseStops[0].setAttribute('stop-color', accentStart);
          roseStops[1].setAttribute('stop-color', accentEnd);
          roseStops[2].setAttribute('stop-color', accentEnd);
        }

        const shadowStops = document.querySelectorAll('#shadowGradient stop');
        if (shadowStops.length >= 2) {
          shadowStops[0].setAttribute('stop-color', accentStart);
          shadowStops[1].setAttribute('stop-color', accentEnd);
        }

        const highlightStops = document.querySelectorAll('#highlightGradient stop');
        if (highlightStops.length >= 2) {
          highlightStops[0].setAttribute('stop-color', accentStart);
          highlightStops[1].setAttribute('stop-color', accentEnd);
        }
      }

      applyThemeToGradients();
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyThemeToGradients);
      
      // SVGã®viewBoxã‚’ç”»é¢ã‚µã‚¤ã‚ºã«å¿œã˜ã¦å‹•çš„ã«èª¿æ•´
      function adjustSVGViewBox() {
        const containerWidth = window.innerWidth;
        const containerHeight = window.innerHeight;
        const size = Math.min(containerWidth, containerHeight);
        
        // viewBoxã®ã‚µã‚¤ã‚ºã‚’å¤§å¹…ã«æ‹¡å¤§ã—ã¦è¦‹åˆ‡ã‚Œã‚’é˜²æ­¢
        let viewBoxSize = 500; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’å¤§å¹…ã«å¢—åŠ ï¼ˆ400â†’500ï¼‰
        
        if (size <= 480) {
          viewBoxSize = 450; // ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ï¼ˆ350â†’450ï¼‰
        } else if (size <= 1024) {
          viewBoxSize = 475; // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆï¼ˆ375â†’475ï¼‰
        } else {
          viewBoxSize = 500; // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ï¼ˆ400â†’500ï¼‰
        }
        
        svg.setAttribute('viewBox', `-${viewBoxSize} -${viewBoxSize} ${viewBoxSize * 2} ${viewBoxSize * 2}`);
      }
      
      // åˆæœŸèª¿æ•´
      adjustSVGViewBox();
      
      // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã®èª¿æ•´
      window.addEventListener('resize', adjustSVGViewBox);
      
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¤‰æ•°
      let startTime = Date.now();
      const minDuration = 3500; // æœ€å°4.5ç§’é–“ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ6â†’4.5ç§’ã«çŸ­ç¸®ï¼‰
      const maxDuration = 5500; // æœ€å¤§6ç§’é–“ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ8â†’6ç§’ã«çŸ­ç¸®ï¼‰
      let animationId;
      
      // æ­£è‘‰æ›²ç·šã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: r = a * cos(n * Î¸)
      const n = 3; // è‘‰ã®æ•°ï¼ˆ3æšè‘‰ã§å„ªé›…ã«ï¼‰
      const a = 1; // åŸºæº–åŠå¾„
      const baseRadius = 150; // SVGåº§æ¨™ç³»ã§ã®åŸºæº–åŠå¾„ï¼ˆ120â†’150ã«æ‹¡å¤§ï¼‰
      
      // ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°é–¢æ•°ï¼ˆã‚ˆã‚Šã‚†ã£ãã‚Šã¨ã—ãŸå¤‰åŒ–ï¼‰
      function easeInOutQuart(t) {
        return t < 0.5 ? 8 * t * t * t * t : 1 - Math.pow(-2 * t + 2, 4) / 2;
      }
      
      // ã‚ˆã‚Šç©ã‚„ã‹ãªã‚¤ãƒ¼ã‚¸ãƒ³ã‚°é–¢æ•°ï¼ˆæœ€åˆã¨æœ€å¾Œã‚’ã‚†ã£ãã‚Šï¼‰
      function gentleEasing(t) {
        // ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°ï¼šæœ€åˆã¨æœ€å¾Œã‚’éå¸¸ã«ã‚†ã£ãã‚Šã€ä¸­é–“ã‚’æ»‘ã‚‰ã‹ã«
        return t * t * (3 - 2 * t); // ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ãƒ†ãƒƒãƒ—é–¢æ•°
      }
      
      // æ­£è‘‰æ›²ç·šã®åº§æ¨™ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
      function getRoseCoordinates(theta, amplitude = 1, frequency = 1, offset = 0) {
        const r = amplitude * Math.cos(frequency * theta) * baseRadius;
        const x = r * Math.cos(theta + offset);
        const y = r * Math.sin(theta + offset);
        return { x, y };
      }
      
      // SVGãƒ‘ã‚¹æ–‡å­—åˆ—ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ï¼ˆå·¦ç«¯ã‹ã‚‰æµã‚Œã‚‹ã‚ˆã†ã«ï¼‰
      function generateRosePath(progress, amplitude, frequency, offset = 0, startAngle = -Math.PI, endAngle = Math.PI) {
        let pathData = '';
        const totalRange = endAngle - startAngle;
        const currentRange = totalRange * progress;
        const steps = Math.max(300, Math.floor(currentRange * 150)); // ã‚¹ãƒ†ãƒƒãƒ—æ•°å¢—åŠ ã§æ»‘ã‚‰ã‹ã«
        
        if (steps <= 0) return '';
        
        for (let i = 0; i <= steps; i++) {
          const theta = startAngle + (currentRange * i) / steps;
          const { x, y } = getRoseCoordinates(theta, amplitude, frequency, offset);
          
          if (i === 0) {
            pathData += `M ${x} ${y}`;
          } else {
            pathData += ` L ${x} ${y}`;
          }
        }
        
        return pathData;
      }
      
      function animate() {
        const currentTime = Date.now();
        const elapsed = currentTime - startTime;
        
        // å‹•çš„ãªç¶™ç¶šæ™‚é–“è¨ˆç®—
        const loadComplete = document.readyState === 'complete';
        const duration = loadComplete ? minDuration : maxDuration;
        const rawProgress = Math.min(elapsed / duration, 1);
        const progress = gentleEasing(rawProgress); // ã‚ˆã‚Šç©ã‚„ã‹ãªã‚¤ãƒ¼ã‚¸ãƒ³ã‚°é©ç”¨
        
        if (progress <= 0.2) {
          // 0-20%: å·¦ç«¯ã‹ã‚‰æ­£è‘‰æ›²ç·šãŒé€Ÿã‚„ã‹ã«æµã‚Œå§‹ã‚ã‚‹ï¼ˆ25%â†’20%ã«çŸ­ç¸®ï¼‰
          const phaseProgress = progress / 0.2;
          const smoothPhase = gentleEasing(phaseProgress); // ãƒ•ã‚§ãƒ¼ã‚ºå†…ã§ã‚‚ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°é©ç”¨
          const amplitude = 0.3 + (0.4 * smoothPhase); // ã‚ˆã‚Šæ—©ã„æŒ¯å¹…å¤‰åŒ–
          const frequency = n; // åŸºæœ¬å‘¨æ³¢æ•°
          
          const mainPath = generateRosePath(smoothPhase, amplitude, frequency);
          path.setAttribute('d', mainPath);
          path.setAttribute('stroke-width', '1.5');
          path.setAttribute('opacity', '0.7');
          
          // ã‚·ãƒ£ãƒ‰ã‚¦ã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚‚åŒæœŸ
          shadowPath.setAttribute('d', mainPath);
          highlightPath.setAttribute('d', mainPath);
          
        } else if (progress <= 0.45) {
          // 20-45%: æŒ¯å¹…ãŒæ€¥é€Ÿã«å¤§ããã€å‘¨æœŸãŒçŸ­ãå¤‰åŒ–ï¼ˆãƒ”ãƒ¼ã‚¯ã‚’æ—©ãï¼‰
          const phaseProgress = (progress - 0.2) / 0.25;
          const smoothPhase = gentleEasing(phaseProgress);
          const amplitude = 0.7 + (1.4 * smoothPhase); // ã‚ˆã‚Šæ€¥é€Ÿãªå¢—åŠ ã§ãƒ”ãƒ¼ã‚¯ã‚’æ—©ã
          const frequency = n + (2.2 * smoothPhase); // å‘¨æœŸå¤‰åŒ–ã‚‚æ€¥é€Ÿ
          
          // å³å´ã‹ã‚‰ã‚«ãƒ¼ãƒ–ãŒé‡ãªã‚Šåˆã„å§‹ã‚ã‚‹
          const leftPath = generateRosePath(1, amplitude, frequency, 0, -Math.PI, 0);
          const rightPath = generateRosePath(smoothPhase, amplitude, frequency, Math.PI, 0, Math.PI);
          
          const combinedPath = leftPath + ' ' + rightPath;
          path.setAttribute('d', combinedPath);
          path.setAttribute('stroke-width', '2.5');
          path.setAttribute('opacity', '0.85');
          
          // ã‚·ãƒ£ãƒ‰ã‚¦ã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚‚åŒæœŸ
          shadowPath.setAttribute('d', combinedPath);
          highlightPath.setAttribute('d', combinedPath);
          
        } else if (progress <= 0.65) {
          // 45-65%: ç”»é¢å…¨ä½“ãŒæ­£è‘‰æ›²ç·šã®å¯†ãªãƒ©ã‚¤ãƒ³ã§åŸ‹ã‚å°½ãã•ã‚Œã‚‹ï¼ˆãƒ”ãƒ¼ã‚¯ç¶­æŒï¼‰
          const phaseProgress = (progress - 0.45) / 0.2;
          const smoothPhase = gentleEasing(phaseProgress);
          const amplitude = 2.1 + (0.3 * smoothPhase); // ãƒ”ãƒ¼ã‚¯æŒ¯å¹…ã‚’æ—©ãåˆ°é”ãƒ»ç¶­æŒ
          const frequency = n + 2.2 + (0.3 * smoothPhase); // é«˜å‘¨æ³¢æ•°ã‚’ç¶­æŒ
          
          // è¤‡æ•°ã®é‡ãªã‚Šã§å¯†åº¦ã‚’ä¸Šã’ã‚‹
          let combinedPath = '';
          for (let layer = 0; layer < 3; layer++) {
            const layerOffset = (layer * Math.PI * 2) / 3;
            const layerPath = generateRosePath(1, amplitude, frequency, layerOffset);
            combinedPath += layerPath + ' ';
          }
          
          path.setAttribute('d', combinedPath);
          path.setAttribute('stroke-width', '2.5');
          path.setAttribute('opacity', '0.95');
          
          // ã‚·ãƒ£ãƒ‰ã‚¦ã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚‚åŒæœŸ
          shadowPath.setAttribute('d', combinedPath);
          highlightPath.setAttribute('d', combinedPath);
          
        } else {
          // 65-100%: æŒ¯å¹…æ¸›å°‘ã€å‘¨æœŸå»¶é•·ã€å³ç«¯ã‹ã‚‰ã‚†ã£ãã‚Šã¨æ¶ˆå¤±
          const phaseProgress = (progress - 0.65) / 0.35;
          const smoothPhase = gentleEasing(phaseProgress); // ã‚†ã£ãã‚Šã¨ã—ãŸãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
          const amplitude = 2.4 * (1 - smoothPhase * 0.75); // ã‚ˆã‚Šç©ã‚„ã‹ãªæŒ¯å¹…æ¸›å°‘
          const frequency = (n + 2.5) * (1 - smoothPhase * 0.3); // å‘¨æœŸå»¶é•·ã‚’ã‚†ã£ãã‚Š
          
          // å³ç«¯ã‹ã‚‰æ¶ˆãˆã¦ã„ãåŠ¹æœï¼ˆã‚†ã£ãã‚Šã¨ã—ãŸãƒ•ã‚§ãƒ¼ãƒ‰ï¼‰
          const visibleRange = 1 - (smoothPhase * 0.60);
          const fadePath = generateRosePath(visibleRange, amplitude, frequency, 0, -Math.PI, Math.PI * visibleRange);
          
          path.setAttribute('d', fadePath);
          path.setAttribute('stroke-width', `${2.5 * (1 - smoothPhase * 0.6)}`);
          path.setAttribute('opacity', `${0.95 * (1 - smoothPhase * 0.7)}`);
          
          // ã‚·ãƒ£ãƒ‰ã‚¦ã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚‚åŒæœŸï¼ˆã‚†ã£ãã‚Šã¨ã—ãŸãƒ•ã‚§ãƒ¼ãƒ‰ï¼‰
          shadowPath.setAttribute('d', fadePath);
          highlightPath.setAttribute('d', fadePath);
          shadowPath.setAttribute('opacity', `${0.3 * (1 - smoothPhase * 0.6)}`);
          highlightPath.setAttribute('opacity', `${0.6 * (1 - smoothPhase * 0.6)}`);
        }
        
        if (progress < 1) {
          animationId = requestAnimationFrame(animate);
        } else {
          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº† - å…¨è¦ç´ ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
          path.setAttribute('opacity', '0');
          shadowPath.setAttribute('opacity', '0');
          highlightPath.setAttribute('opacity', '0');
          
          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’å®Œå…¨ã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
          setTimeout(() => {
            fadeOutLoadingScreen();
          }, 100);
        }
      }
      
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
      animate();
    }
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
    function fadeOutLoadingScreen() {
      const loadingScreen = document.getElementById('loadingScreen');
      const mainContent = document.getElementById('mainContent');
      
      // 300ms ease-out ãƒ•ã‚§ãƒ¼ãƒ‰
      loadingScreen.style.transition = 'opacity 0.3s ease-out, visibility 0.3s ease-out';
      loadingScreen.classList.add('hidden');
      
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ã«ã™ã‚‹
      enableScroll();
      
      // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
      setTimeout(() => {
        mainContent.classList.add('visible');
      }, 50); // 150ms â†’ 50ms
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', () => {
      const filterToggle = document.getElementById('filterToggle');
      const mobileFilter = document.querySelector('.mobile-filter');
      const overlay = document.getElementById('filterOverlay');
      const closeBtn = document.getElementById('closeFilter');
      // ä¿å­˜ã•ã‚ŒãŸæ¤œç´¢æ¡ä»¶ã‚’å–å¾—
      const savedSearch = localStorage.getItem('searchInput') || '';
      const savedSubject = localStorage.getItem('subjectFilter') || '';
      const savedGrade = localStorage.getItem('gradeFilter') || '';
      const savedPeriod = localStorage.getItem('periodFilter') || '';

      if (savedSearch) {
        document.getElementById('searchInput').value = savedSearch;
      }
      if (filterToggle && mobileFilter && overlay) {
        filterToggle.addEventListener('click', () => {
          const isOpen = mobileFilter.classList.contains('open');
          filterToggle.setAttribute('aria-expanded', String(!isOpen));
          mobileFilter.classList.toggle('open');
          overlay.classList.toggle('open');
        });
      }
      closeBtn?.addEventListener('click', () => {
        mobileFilter.classList.remove('open');
        overlay.classList.remove('open');
        filterToggle.setAttribute('aria-expanded', 'false');
      });
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹ã«ã™ã‚‹
      disableScroll();

      const isSmallScreen = window.matchMedia('(max-width: 480px)').matches;

      // æ­£è‘‰æ›²ç·šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¾ãŸã¯ã‚¹ãƒ”ãƒŠãƒ¼ã‚’é–‹å§‹
      if (isSmallScreen) {
        const spinner = document.getElementById('spinnerContainer');
        if (spinner) {
          spinner.style.display = 'flex';
        }
      } else {
        startRoseLoadingAnimation();
      }
      
      // åˆæœŸåŒ–å®Œäº†å¾Œã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢åˆ¶å¾¡
      initializeFilters().then(() => {
        // ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚£ãƒ«ã‚¿å€¤ã‚’ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«é©ç”¨
        document.getElementById('subjectFilter').value = savedSubject;
        document.getElementById('gradeFilter').value = savedGrade;
        document.getElementById('periodFilter').value = savedPeriod;

        if (savedSearch || savedSubject || savedGrade || savedPeriod) {
          search();
        }
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®æœ€å°è¡¨ç¤ºæ™‚é–“ã‚’ç¢ºä¿ï¼ˆæ™‚é–“çŸ­ç¸®ï¼‰
        const loadingStartTime = Date.now();
        const minDisplayTime = 700; // 1.5ç§’ â†’ 700ãƒŸãƒªç§’ã«çŸ­ç¸®
        
        setTimeout(() => {
          const elapsedTime = Date.now() - loadingStartTime;
          const remainingTime = Math.max(0, minDisplayTime - elapsedTime);

          setTimeout(() => {
            if (isSmallScreen) {
              fadeOutLoadingScreen();
            }
            // å¤§ç”»é¢ã§ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®çµ‚äº†ã‚’å¾…ã¤
          }, remainingTime);
        }, 100);
      }).catch((error) => {
        console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã¯é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§éè¡¨ç¤ºã«ã™ã‚‹
        setTimeout(() => {
          fadeOutLoadingScreen();
        }, 2500); // ã‚¨ãƒ©ãƒ¼æ™‚ã®è¡¨ç¤ºæ™‚é–“ã‚‚çŸ­ç¸®ï¼ˆ3ç§’â†’2.5ç§’ï¼‰
      });
    });

    // Enterã‚­ãƒ¼ã§æ¤œç´¢
    document.getElementById('searchInput')?.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        // Google Analytics: Enterã‚­ãƒ¼ã«ã‚ˆã‚‹æ¤œç´¢ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½è·¡
        sendGAEvent('search_enter_key', 'user_interaction', 'search_input');
        search();
      }
    });

    // å…¥åŠ›å†…å®¹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    document.getElementById('searchInput')?.addEventListener('input', function(e) {
      localStorage.setItem('searchInput', e.target.value);
    });

    // initializeFiltersé–¢æ•°ã‚’Promiseã‚’è¿”ã™ã‚ˆã†ã«ä¿®æ­£
    async function initializeFilters() {
      try {
        const response = await fetch('/filters');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
        filterOptions = data;
        
        // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
        populateFilterOptions('subjectFilter', data.subjects);
        populateFilterOptions('gradeFilter', data.grades);
        populateFilterOptions('periodFilter', data.periods);
        
        console.log('ãƒ•ã‚£ãƒ«ã‚¿ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('ãƒ•ã‚£ãƒ«ã‚¿ã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
        throw error;
      }
    }
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js');
      });
    }
  </script>
  </div> <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„çµ‚äº† -->
</body>
</html>
