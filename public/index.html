<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>過去問検索システム</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      color: #2c3e50;
      line-height: 1.6;
      overflow-x: hidden;
      position: relative;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><radialGradient id="grain"><stop offset="0%" stop-color="white" stop-opacity="0.1"/><stop offset="100%" stop-color="transparent"/></radialGradient></defs><circle cx="50" cy="50" r="1" fill="url(%23grain)"/></svg>') repeat;
      pointer-events: none;
      opacity: 0.1;
      z-index: -1;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      animation: fadeInUp 0.8s ease-out;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }
    
    @keyframes float {
      0%, 100% {
        transform: translateY(0px);
      }
      50% {
        transform: translateY(-5px);
      }
    }
    
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #2c3e50 0%, #4a5568 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 4px 8px rgba(0,0,0,0.1);
      animation: slideIn 1s ease-out 0.2s both;
    }
    
    .search-box {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 30px;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.3);
      animation: slideIn 1s ease-out 0.4s both;
      transition: all 0.3s ease;
    }
    
    .search-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(31, 38, 135, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.4);
    }
    
    #searchInput {
      padding: 16px 20px;
      border: 2px solid rgba(255, 255, 255, 0.4);
      border-radius: 15px;
      font-size: 16px;
      background: rgba(255, 255, 255, 0.95);
      color: #2c3e50;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    #searchInput:focus {
      outline: none;
      border-color: rgba(255, 145, 115, 0.6);
      background: rgba(255, 255, 255, 1);
      box-shadow: 0 0 20px rgba(255, 145, 115, 0.2);
      transform: scale(1.02);
    }
    
    #searchInput::placeholder {
      color: #718096;
    }
    
    button {
      background: linear-gradient(135deg, rgba(255, 145, 115, 0.85) 0%, rgba(255, 138, 101, 0.85) 100%);
      color: white;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      min-height: 50px;
      touch-action: manipulation;
      transition: all 0.3s ease;
      position: relative;
      backdrop-filter: blur(10px);
      overflow: hidden;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s ease;
    }
    
    button:hover::before {
      left: 100%;
    }
    
    button:hover, button:active {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 145, 115, 0.3);
      background: linear-gradient(135deg, rgba(255, 134, 101, 0.9) 0%, rgba(255, 114, 86, 0.9) 100%);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    /* タブレット以上のサイズ */
    @media (min-width: 768px) {
      body {
        padding: 0;
      }
      .container {
        padding: 40px;
      }
      h1 {
        font-size: 3.5rem;
        margin-bottom: 40px;
      }
      .search-box {
        flex-direction: row;
        align-items: stretch;
        padding: 30px;
      }
      #searchInput {
        flex: 1;
        margin-right: 15px;
        font-size: 18px;
        padding: 18px 24px;
      }
      button {
        padding: 0 30px;
        font-size: 18px;
        min-width: 120px;
      }
    }
    
    .result-item {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      margin: 15px 0;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
      animation: slideIn 0.6s ease-out;
    }
    
    .result-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 40px rgba(31, 38, 135, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.4);
    }
    
    .result-title {
      font-size: 18px;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 15px;
      cursor: pointer;
      line-height: 1.4;
      min-height: 44px;
      display: flex;
      align-items: center;
      transition: all 0.3s ease;
    }
    
    .result-title:hover, .result-title:active {
      color: #667eea;
      text-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    }
    
    .result-meta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    
    .meta-item {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 4px 12px rgba(31, 38, 135, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .meta-item:hover {
      transform: scale(1.05);
      background: rgba(255, 255, 255, 0.6);
      box-shadow: 0 6px 16px rgba(31, 38, 135, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    /* タブレット以上のサイズ */
    @media (min-width: 768px) {
      .result-item {
        margin: 20px 0;
        padding: 25px;
      }
      .result-title {
        font-size: 20px;
        min-height: auto;
      }
      .result-meta {
        gap: 15px;
      }
      .meta-item {
        padding: 6px 10px;
        font-size: 14px;
      }
    }
    
    .subject {
      background: rgba(212, 237, 218, 0.8);
      color: #155724;
      border-color: rgba(21, 87, 36, 0.3);
    }
    .grade {
      background: rgba(204, 229, 255, 0.8);
      color: #004085;
      border-color: rgba(0, 64, 133, 0.3);
    }
    .period {
      background: rgba(226, 212, 255, 0.8);
      color: #4b0082;
      border-color: rgba(75, 0, 130, 0.3);
    }
    
    .files-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.3);
      animation: fadeInUp 0.6s ease-out;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 15px;
      margin: 10px 0;
      transition: all 0.3s ease;
      backdrop-filter: blur(15px);
      box-shadow: 0 4px 12px rgba(31, 38, 135, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .file-item:hover {
      background: rgba(255, 255, 255, 0.5);
      transform: translateX(5px);
      box-shadow: 0 6px 16px rgba(31, 38, 135, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    .pdf-icon {
      color: #ff6b6b;
      font-weight: bold;
      font-size: 20px;
      animation: float 3s ease-in-out infinite;
    }
    
    .file-link {
      color: #2c3e50;
      text-decoration: none;
      flex: 1;
      font-size: 15px;
      min-height: 44px;
      display: flex;
      align-items: center;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .file-link:hover, .file-link:active {
      text-decoration: underline;
      color: rgba(255, 145, 115, 0.9);
    }
    
    .file-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .file-btn {
      padding: 10px 14px;
      background: linear-gradient(135deg, rgba(255, 167, 132, 0.8) 0%, rgba(255, 152, 121, 0.8) 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      min-height: 40px;
      white-space: nowrap;
      font-weight: 600;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(8px);
    }
    
    .file-btn.open-tab {
      background: linear-gradient(135deg, rgba(255, 193, 125, 0.8) 0%, rgba(255, 183, 107, 0.8) 100%);
    }
    
    .file-btn:hover, .file-btn:active {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .pdf-viewer {
      width: 100%;
      height: 400px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 15px;
      margin-top: 15px;
      backdrop-filter: blur(10px);
      animation: fadeInUp 0.6s ease-out;
    }
    
    .page-content {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      padding: 25px;
      margin: 15px 0;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.3);
      animation: fadeInUp 0.6s ease-out;
    }
    
    .page-content h4 {
      margin-top: 0;
      color: #2c3e50;
      font-weight: 600;
      margin-bottom: 20px;
      font-size: 1.2rem;
      border-bottom: 2px solid rgba(44, 62, 80, 0.2);
      padding-bottom: 10px;
    }
    
    .page-text {
      line-height: 1.7;
      color: #2c3e50;
    }
    
    .page-text h1 {
      font-size: 1.6em;
      font-weight: bold;
      margin: 1em 0 0.5em 0;
      color: #2c3e50;
      border-bottom: 2px solid rgba(44, 62, 80, 0.3);
      padding-bottom: 0.3em;
    }
    
    .page-text h2 {
      font-size: 1.4em;
      font-weight: bold;
      margin: 1em 0 0.5em 0;
      color: #2c3e50;
      border-bottom: 1px solid rgba(44, 62, 80, 0.2);
      padding-bottom: 0.2em;
    }
    
    .page-text h3 {
      font-size: 1.2em;
      font-weight: bold;
      margin: 1em 0 0.5em 0;
      color: #2c3e50;
    }
    
    .page-text p {
      margin: 0.8em 0;
    }
    
    .page-text ul, .page-text ol {
      margin: 0.8em 0;
      padding-left: 1.5em;
    }
    
    .page-text li {
      margin: 0.3em 0;
    }
    
    .page-text table {
      border-collapse: collapse;
      width: 100%;
      margin: 1em 0;
      border: 1px solid rgba(44, 62, 80, 0.2);
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(5px);
      border-radius: 10px;
      overflow: hidden;
    }
    
    .page-text th,
    .page-text td {
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 12px 15px;
      text-align: left;
    }
    
    .page-text th {
      background: rgba(255, 255, 255, 0.2);
      font-weight: bold;
      color: #fff;
    }
    
    .page-text tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.05);
    }
    
    /* タブレット以上のサイズ */
    @media (min-width: 768px) {
      .file-item {
        padding: 12px;
      }
      .file-link {
        min-height: auto;
      }
      .file-btn {
        min-height: auto;
      }
      .pdf-viewer {
        height: 600px;
        max-width: 100vw;
      }
      .page-content {
        padding: 25px;
      }
    }
    
    .loading {
      text-align: center;
      color: #2c3e50;
      padding: 30px;
      font-size: 18px;
      font-weight: 500;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      border: 1px solid rgba(44, 62, 80, 0.2);
      backdrop-filter: blur(10px);
      animation: pulse 2s ease-in-out infinite;
    }
    
    .error {
      color: #ff6b6b;
      background: rgba(248, 215, 218, 0.15);
      backdrop-filter: blur(10px);
      padding: 15px;
      border-radius: 15px;
      margin: 15px 0;
      border: 1px solid rgba(220, 53, 69, 0.3);
      animation: slideIn 0.6s ease-out;
    }
    
    .filters {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 30px;
      padding: 25px;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.3);
      animation: slideIn 1s ease-out 0.6s both;
      transition: all 0.3s ease;
    }
    
    .filters:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(31, 38, 135, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.4);
    }
    
    .filter-row {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      transition: all 0.3s ease;
    }
    
    .filter-group:hover {
      transform: translateY(-2px);
    }
    
    .filter-label {
      font-size: 15px;
      font-weight: 600;
      color: #2c3e50;
      text-shadow: 0 1px 2px rgba(255,255,255,0.5);
      margin-bottom: 8px;
      display: block;
      transition: all 0.3s ease;
    }
    
    .filter-group:hover .filter-label {
      color: rgba(255, 145, 115, 0.9);
      transform: translateY(-1px);
    }
    
    select {
      padding: 14px 20px;
      border: 2px solid rgba(255, 255, 255, 0.4);
      border-radius: 15px;
      font-size: 16px;
      background: rgba(255, 255, 255, 0.9);
      color: #2c3e50;
      min-height: 50px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      transition: all 0.3s ease;
      backdrop-filter: blur(15px);
      box-shadow: 0 4px 12px rgba(31, 38, 135, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.3);
      cursor: pointer;
      position: relative;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23718096' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 16px;
      padding-right: 45px;
    }
    
    select:focus {
      outline: none;
      border-color: rgba(255, 145, 115, 0.6);
      background: rgba(255, 255, 255, 1);
      box-shadow: 0 0 20px rgba(255, 145, 115, 0.2), 0 6px 20px rgba(31, 38, 135, 0.15);
      transform: scale(1.02);
    }
    
    select:hover {
      border-color: rgba(255, 145, 115, 0.4);
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 6px 16px rgba(31, 38, 135, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.4);
      transform: translateY(-1px);
    }
    
    /* FirefoxのSelectドロップダウンのカスタマイズ */
    select option {
      background: rgba(255, 255, 255, 0.95);
      color: #2c3e50;
      padding: 12px 16px;
      font-size: 16px;
      border: none;
      backdrop-filter: blur(10px);
    }
    
    select option:hover,
    select option:focus,
    select option:checked {
      background: rgba(255, 145, 115, 0.2);
      color: #2c3e50;
    }
    
    /* Webkitベースのブラウザ（Chrome, Safari）でのオプションスタイル */
    @supports (-webkit-appearance: none) {
      select {
        background-color: rgba(255, 255, 255, 0.9);
      }
    }
    
    .clear-filters {
      padding: 14px 20px;
      background: linear-gradient(135deg, rgba(255, 158, 128, 0.85) 0%, rgba(255, 138, 101, 0.85) 100%);
      color: white;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      min-height: 50px;
      backdrop-filter: blur(10px);
      margin-top: 15px;
      transition: all 0.3s ease;
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 12px rgba(31, 38, 135, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
    }
    
    .clear-filters::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s ease;
    }
    
    .clear-filters:hover::before {
      left: 100%;
    }
    
    .clear-filters:hover, .clear-filters:active {
      background: linear-gradient(135deg, rgba(255, 134, 101, 0.9) 0%, rgba(255, 114, 86, 0.9) 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 145, 115, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    .clear-filters:active {
      transform: translateY(0);
    }
    
    .pagination-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    /* タブレット以上のサイズ */
    @media (min-width: 768px) {
      .filters {
        flex-direction: row;
        align-items: flex-end;
        flex-wrap: wrap;
        padding: 30px;
      }
      .filter-row {
        flex-direction: row;
        flex: 1;
      }
      select {
        padding: 12px 20px;
        font-size: 16px;
        min-height: auto;
        padding-right: 45px;
      }
      .clear-filters {
        padding: 12px 20px;
        min-height: auto;
        margin-top: 0;
        align-self: flex-end;
      }
    }

    /* スマートフォン向けの追加スタイル */
    @media (max-width: 767px) {
      h1 {
        font-size: 2rem;
      }
      
      .search-box {
        padding: 20px;
        gap: 12px;
      }
      
      #searchInput {
        padding: 14px 16px;
        font-size: 16px;
      }
      
      button {
        padding: 14px 20px;
        font-size: 16px;
      }
      
      .result-item {
        padding: 15px;
        margin: 10px 0;
      }
      
      .result-title {
        font-size: 16px;
      }
      
      .meta-item {
        padding: 6px 10px;
        font-size: 12px;
      }
      
      .file-item {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      
      .file-actions {
        width: 100%;
        justify-content: space-between;
      }
      
      .file-btn {
        flex: 1;
        text-align: center;
      }
      
      .filters {
        padding: 20px;
        gap: 15px;
      }
      
      .filter-group {
        gap: 6px;
      }
      
      select {
        padding: 12px;
        font-size: 16px;
      }
    }

    /* 追加のアニメーション */
    .result-item:nth-child(even) {
      animation-delay: 0.1s;
    }
    
    .result-item:nth-child(odd) {
      animation-delay: 0.2s;
    }
    
    /* ローディングアニメーション */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(44, 62, 80, 0.3);
      border-radius: 50%;
      border-top-color: #2c3e50;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>過去問検索システム</h1>
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="科目名やキーワードを入力してください" />
      <button onclick="search()">検索</button>
    </div>
    
    <!-- フィルタセクション -->
    <div class="filters">
      <div class="filter-row">
        <div class="filter-group">
          <label class="filter-label">教科</label>
          <select id="subjectFilter">
            <option value="">すべて</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">学年</label>
          <select id="gradeFilter">
            <option value="">すべて</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">時期</label>
          <select id="periodFilter">
            <option value="">すべて</option>
          </select>
        </div>
      </div>
      <button class="clear-filters" onclick="clearFilters()">フィルタをクリア</button>
    </div>
    
    <div id="results"></div>
  </div>

  <script>
    // フィルタオプションを格納する変数
    let filterOptions = {
      subjects: new Set(),
      grades: new Set(),
      periods: new Set()
    };

    // ページ詳細のキャッシュ
    const pageDetailsCache = new Map();

    // データを整理して表示する関数
    function formatProperty(property) {
      if (property.type === 'title') {
        return property.title.map(t => t.plain_text).join('');
      } else if (property.type === 'multi_select') {
        return property.multi_select.map(s => s.name).join(', ');
      } else if (property.type === 'select' && property.select) {
        return property.select.name;
      } else if (property.type === 'date' && property.date) {
        return property.date.start;
      } else if (property.type === 'number' && property.number !== null) {
        return property.number.toString();
      } else if (property.type === 'rich_text') {
        return property.rich_text.map(t => t.plain_text).join('');
      }
      return '';
    }

    // Markdownテキストを解析してHTMLに変換する関数
    function parseMarkdownToHTML(markdown) {
      if (!markdown) return '';
      
      // 行ごとに分割
      const lines = markdown.split('\n');
      let html = '';
      let inList = false;
      let listType = null;
      let inTable = false;
      let isFirstTableRow = true;
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const trimmedLine = line.trim();
        
        if (!trimmedLine) {
          continue;
        }
        
        // テーブル開始マーカーの処理
        if (trimmedLine === '[TABLE_START]') {
          if (inList) {
            html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
            inList = false;
            listType = null;
          }
          inTable = true;
          isFirstTableRow = true;
          html += '<table>\n';
          continue;
        }
        
        // テーブル行の検出（|で区切られた行）
        if (trimmedLine.includes('|') && trimmedLine.split('|').length > 2) {
          const cells = trimmedLine.split('|').map(cell => cell.trim()).filter(cell => cell);
          
          if (!inTable) {
            // テーブル開始
            if (inList) {
              html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
              inList = false;
              listType = null;
            }
            html += '<table>\n';
            inTable = true;
            isFirstTableRow = true;
          }
          
          if (isFirstTableRow) {
            html += '<thead>\n<tr>\n';
            cells.forEach(cell => {
              html += `<th>${cell}</th>\n`;
            });
            html += '</tr>\n</thead>\n<tbody>\n';
            isFirstTableRow = false;
          } else {
            html += '<tr>\n';
            cells.forEach(cell => {
              html += `<td>${cell}</td>\n`;
            });
            html += '</tr>\n';
          }
          continue;
        }
        
        // テーブル以外の処理の場合、テーブルを終了
        if (inTable) {
          html += '</tbody></table>\n';
          inTable = false;
          isFirstTableRow = true;
        }
        
        // 見出し
        if (trimmedLine.startsWith('### ')) {
          if (inList) {
            html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
            inList = false;
            listType = null;
          }
          html += `<h3>${trimmedLine.substring(4)}</h3>\n`;
        } else if (trimmedLine.startsWith('## ')) {
          if (inList) {
            html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
            inList = false;
            listType = null;
          }
          html += `<h2>${trimmedLine.substring(3)}</h2>\n`;
        } else if (trimmedLine.startsWith('# ')) {
          if (inList) {
            html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
            inList = false;
            listType = null;
          }
          html += `<h1>${trimmedLine.substring(2)}</h1>\n`;
        }
        // 箇条書き
        else if (trimmedLine.startsWith('• ') || trimmedLine.startsWith('- ')) {
          if (!inList || listType !== 'ul') {
            if (inList && listType === 'ol') {
              html += '</ol>\n';
            }
            html += '<ul>\n';
            inList = true;
            listType = 'ul';
          }
          html += `<li>${trimmedLine.substring(2)}</li>\n`;
        }
        // 番号付きリスト
        else if (/^\d+\.\s/.test(trimmedLine)) {
          if (!inList || listType !== 'ol') {
            if (inList && listType === 'ul') {
              html += '</ul>\n';
            }
            html += '<ol>\n';
            inList = true;
            listType = 'ol';
          }
          html += `<li>${trimmedLine.replace(/^\d+\.\s/, '')}</li>\n`;
        }
        // 通常の段落
        else {
          if (inList) {
            html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
            inList = false;
            listType = null;
          }
          html += `<p>${trimmedLine}</p>\n`;
        }
      }
      
      // 最後にリストやテーブルが開いている場合は閉じる
      if (inList) {
        html += listType === 'ul' ? '</ul>\n' : '</ol>\n';
      }
      if (inTable) {
        html += '</tbody></table>\n';
      }
      
      return html;
    }

    // フィルタオプションを初期化
    async function initializeFilters() {
      try {
        const response = await fetch('/filters');
        const data = await response.json();
        
        filterOptions = data;
        
        // セレクトボックスにオプションを追加
        populateFilterOptions('subjectFilter', data.subjects);
        populateFilterOptions('gradeFilter', data.grades);
        populateFilterOptions('periodFilter', data.periods);
      } catch (error) {
        console.error('フィルタ初期化エラー:', error);
      }
    }

    function populateFilterOptions(selectId, options) {
      const select = document.getElementById(selectId);
      // 既存のオプション（"すべて"以外）をクリア
      while (select.children.length > 1) {
        select.removeChild(select.lastChild);
      }
      
      // 新しいオプションを追加
      options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        select.appendChild(optionElement);
      });
    }

    function clearFilters() {
      document.getElementById('subjectFilter').value = '';
      document.getElementById('gradeFilter').value = '';
      document.getElementById('periodFilter').value = '';
      search(); // フィルタクリア後に再検索
    }

    async function search() {
      const query = document.getElementById('searchInput').value;
      const subject = document.getElementById('subjectFilter').value;
      const grade = document.getElementById('gradeFilter').value;
      const period = document.getElementById('periodFilter').value;
      const resultsDiv = document.getElementById('results');
      
      resultsDiv.innerHTML = '<div class="loading">検索中</div>';
      
      // URLパラメータを構築
      const params = new URLSearchParams();
      if (query) params.append('q', query);
      if (subject) params.append('subject', subject);
      if (grade) params.append('grade', grade);
      if (period) params.append('period', period);
      
      try {
        const response = await fetch('/search?' + params.toString());
        const data = await response.json();
        
        resultsDiv.innerHTML = '';
        
        if (data.length === 0) {
          resultsDiv.innerHTML = '<div class="error">検索結果が見つかりませんでした。</div>';
          return;
        }
        
        for (const item of data) {
          const resultDiv = document.createElement('div');
          resultDiv.className = 'result-item';
          
          // タイトル
          const title = formatProperty(item.properties['名前']) || 'タイトル不明';
          const titleDiv = document.createElement('div');
          titleDiv.className = 'result-title';
          titleDiv.textContent = title;
          
          // メタ情報
          const metaDiv = document.createElement('div');
          metaDiv.className = 'result-meta';
          
          // 教科
          const subjects = formatProperty(item.properties['教科']);
          if (subjects) {
            const subjectSpan = document.createElement('span');
            subjectSpan.className = 'meta-item subject';
            subjectSpan.textContent = `教科: ${subjects}`;
            metaDiv.appendChild(subjectSpan);
          }
          
          // 学年
          const grade = formatProperty(item.properties['学年']);
          if (grade) {
            const gradeSpan = document.createElement('span');
            gradeSpan.className = 'meta-item grade';
            gradeSpan.textContent = `学年: ${grade}`;
            metaDiv.appendChild(gradeSpan);
          }
          
          // 時期
          const period = formatProperty(item.properties['時期']);
          if (period) {
            const periodSpan = document.createElement('span');
            periodSpan.className = 'meta-item period';
            periodSpan.textContent = `時期: ${period}`;
            metaDiv.appendChild(periodSpan);
          }
          
          resultDiv.appendChild(titleDiv);
          resultDiv.appendChild(metaDiv);
          
          // クリックして詳細を表示するリンク
          const showDetailsLink = document.createElement('a');
          showDetailsLink.textContent = 'クリックしてファイルを表示';
          showDetailsLink.href = '#';
          showDetailsLink.style.cssText = `
            display: block;
            margin-top: 20px;
            padding: 16px 30px;
            background: linear-gradient(135deg, rgba(255, 145, 115, 0.85) 0%, rgba(255, 138, 101, 0.85) 100%);
            color: white;
            text-decoration: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(255, 145, 115, 0.2);
            position: relative;
            overflow: hidden;
          `;
          showDetailsLink.onmouseover = () => {
            showDetailsLink.style.background = 'linear-gradient(135deg, rgba(255, 134, 101, 0.9) 0%, rgba(255, 114, 86, 0.9) 100%)';
            showDetailsLink.style.transform = 'translateY(-3px)';
            showDetailsLink.style.boxShadow = '0 8px 25px rgba(255, 145, 115, 0.3)';
          };
          showDetailsLink.onmouseout = () => {
            showDetailsLink.style.background = 'linear-gradient(135deg, rgba(255, 145, 115, 0.85) 0%, rgba(255, 138, 101, 0.85) 100%)';
            showDetailsLink.style.transform = 'translateY(0)';
            showDetailsLink.style.boxShadow = '0 4px 16px rgba(255, 145, 115, 0.2)';
          };
          showDetailsLink.onclick = (e) => {
            e.preventDefault();
            showPageDetails(item.id, resultDiv, showDetailsLink);
          };
          
          resultDiv.appendChild(showDetailsLink);
          resultsDiv.appendChild(resultDiv);
          
          // バックグラウンドでページ詳細を事前読み込み
          preloadPageDetails(item.id);
        }
      } catch (error) {
        console.error('検索エラー:', error);
        resultsDiv.innerHTML = '<div class="error">検索中にエラーが発生しました。</div>';
      }
    }

    // バックグラウンドでページ詳細をプリロード
    async function preloadPageDetails(pageId) {
      // 既にキャッシュされている場合はスキップ
      if (pageDetailsCache.has(pageId)) {
        return;
      }
      
      try {
        const response = await fetch(`/page/${pageId}`);
        const data = await response.json();
        pageDetailsCache.set(pageId, data);
      } catch (error) {
        console.error('ページ詳細のプリロード中にエラーが発生しました:', error);
      }
    }

    // キャッシュされたページ詳細を即座に表示
    async function showPageDetails(pageId, resultDiv, link) {
      // リンクを無効化してローディング表示
      link.style.pointerEvents = 'none';
      link.style.opacity = '0.6';
      link.textContent = '読み込み中...';
      
      try {
        let data = pageDetailsCache.get(pageId);
        
        // キャッシュにない場合は即座に取得
        if (!data) {
          const response = await fetch(`/page/${pageId}`);
          data = await response.json();
          pageDetailsCache.set(pageId, data);
        }
        
        // ファイルセクションを作成
        let filesSection = resultDiv.querySelector('.files-section');
        if (!filesSection) {
          filesSection = document.createElement('div');
          filesSection.className = 'files-section';
          resultDiv.appendChild(filesSection);
        }
        
        filesSection.innerHTML = '';
        
        if (data.files && data.files.length > 0) {
          // ファイル表示エリア
          const filesTitle = document.createElement('h4');
          filesTitle.textContent = 'ファイル:';
          filesSection.appendChild(filesTitle);
          
          data.files.forEach(file => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file-item';
            
            const icon = document.createElement('span');
            icon.className = 'pdf-icon';
            icon.textContent = '📄';
            
            const link = document.createElement('a');
            link.className = 'file-link';
            link.href = file.url;
            link.textContent = file.name;
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'file-actions';
            
            const viewBtn = document.createElement('button');
            viewBtn.className = 'file-btn';
            viewBtn.textContent = '表示';
            viewBtn.onclick = () => showPDF(file.url, file.name, resultDiv);
            
            const openTabBtn = document.createElement('button');
            openTabBtn.className = 'file-btn open-tab';
            openTabBtn.textContent = '新しいタブで開く';
            openTabBtn.onclick = () => window.open(file.url, '_blank', 'noopener,noreferrer');
            
            actionsDiv.appendChild(viewBtn);
            actionsDiv.appendChild(openTabBtn);
            
            fileDiv.appendChild(icon);
            fileDiv.appendChild(link);
            fileDiv.appendChild(actionsDiv);
            filesSection.appendChild(fileDiv);
          });
        }
        
        // ページ内容の表示
        if (data.content && data.content.length > 0) {
          const contentDiv = document.createElement('div');
          contentDiv.className = 'page-content';
          contentDiv.style.marginTop = data.files && data.files.length > 0 ? '20px' : '0';
          
          const contentTitle = document.createElement('h4');
          contentTitle.textContent = 'ページ内容:';
          contentDiv.appendChild(contentTitle);
          
          // 全ての内容を一度に表示
          let markdownContent = '';
          data.content.forEach(block => {
            if (block.type === 'paragraph' && block.paragraph.rich_text) {
              const text = block.paragraph.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += text + '\n\n';
              }
            } else if (block.type === 'heading_1' && block.heading_1.rich_text) {
              const text = block.heading_1.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '# ' + text + '\n\n';
              }
            } else if (block.type === 'heading_2' && block.heading_2.rich_text) {
              const text = block.heading_2.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '## ' + text + '\n\n';
              }
            } else if (block.type === 'heading_3' && block.heading_3.rich_text) {
              const text = block.heading_3.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '### ' + text + '\n\n';
              }
            } else if (block.type === 'bulleted_list_item' && block.bulleted_list_item.rich_text) {
              const text = block.bulleted_list_item.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '• ' + text + '\n';
              }
            } else if (block.type === 'numbered_list_item' && block.numbered_list_item.rich_text) {
              const text = block.numbered_list_item.rich_text.map(text => text.plain_text).join('');
              if (text.trim()) {
                markdownContent += '1. ' + text + '\n';
              }
            } else if (block.type === 'table') {
              markdownContent += '\n[TABLE_START]\n';
            } else if (block.type === 'table_row' && block.table_row && block.table_row.cells) {
              const cells = block.table_row.cells.map(cell => 
                cell.map(text => text.plain_text).join('').trim()
              );
              markdownContent += '| ' + cells.join(' | ') + ' |\n';
            }
          });
          
          if (markdownContent.trim()) {
            const contentText = document.createElement('div');
            contentText.className = 'page-text';
            contentText.innerHTML = parseMarkdownToHTML(markdownContent);
            contentDiv.appendChild(contentText);
          } else {
            const noContentDiv = document.createElement('div');
            noContentDiv.style.color = '#2c3e50';
            noContentDiv.style.fontStyle = 'italic';
            noContentDiv.style.textAlign = 'center';
            noContentDiv.style.padding = '20px';
            noContentDiv.style.background = 'rgba(255, 255, 255, 0.1)';
            noContentDiv.style.borderRadius = '10px';
            noContentDiv.style.border = '1px dashed rgba(44, 62, 80, 0.3)';
            noContentDiv.textContent = 'ページ内容がありません';
            contentDiv.appendChild(noContentDiv);
          }
          
          filesSection.appendChild(contentDiv);
        } else if (!data.files || data.files.length === 0) {
          filesSection.innerHTML = '<div style="color: #2c3e50; font-style: italic; text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; border: 1px dashed rgba(44, 62, 80, 0.3);">ファイルとページ内容はありません</div>';
        }
        
        // リンクを非表示にする
        link.style.display = 'none';
        
      } catch (error) {
        console.error('ページ詳細の表示中にエラーが発生しました:', error);
        link.style.pointerEvents = 'auto';
        link.style.opacity = '1';
        link.textContent = 'クリックしてファイルを表示';
        
        let filesSection = resultDiv.querySelector('.files-section');
        if (!filesSection) {
          filesSection = document.createElement('div');
          filesSection.className = 'files-section';
          resultDiv.appendChild(filesSection);
        }
        filesSection.innerHTML = '<div style="color: #ff6b6b;">エラー: 詳細を取得できませんでした</div>';
      }
    }

    // ページ内容を段階的に読み込む関数
    function showPDF(url, filename, parentDiv) {
      // 既存のPDFビューアーを削除
      const existingViewer = parentDiv.querySelector('.pdf-viewer');
      if (existingViewer) {
        existingViewer.remove();
      }
      
      // PDFビューアーを作成
      const iframe = document.createElement('iframe');
      iframe.className = 'pdf-viewer';
      iframe.src = url;
      iframe.title = filename;
      
      parentDiv.appendChild(iframe);
    }

    // Enterキーで検索
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        search();
      }
    });

    // フィルタ変更時に自動検索
    document.getElementById('subjectFilter').addEventListener('change', search);
    document.getElementById('gradeFilter').addEventListener('change', search);
    document.getElementById('periodFilter').addEventListener('change', search);

    // ページ読み込み時にフィルタ初期化
    window.addEventListener('DOMContentLoaded', () => {
      initializeFilters();
    });
  </script>
</body>
</html>
